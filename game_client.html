<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wargame — Human vs AI</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'JetBrains Mono','Courier New','Consolas',monospace;background:#0a0a1a;color:#d0d0d0;overflow:hidden;height:100vh}

/* Header */
#header{position:fixed;top:0;left:0;right:0;z-index:1000;height:48px;background:#0f1729;border-bottom:1px solid #1e3a5f;display:flex;align-items:center;padding:0 16px;gap:10px}
.title{font-size:13px;font-weight:700;letter-spacing:2px;color:#7eb8da;text-transform:uppercase;white-space:nowrap}
.info{margin-left:auto;font-size:11px;color:#778;display:flex;gap:8px;align-items:center}
.info-pill{background:#1a2744;padding:2px 8px;border-radius:10px;border:1px solid #1e3a5f}

/* Phase overlay */
#phase-overlay{position:fixed;top:58px;left:50%;transform:translateX(-50%);z-index:1001;pointer-events:none;
  background:rgba(12,20,35,.92);padding:6px 24px;border:1px solid #2a4a6f;border-radius:4px;
  font-size:12px;font-weight:700;letter-spacing:3px;text-transform:uppercase;display:none;
  transition:opacity .3s}

/* Header VP compact */
.vp-header{display:flex;align-items:center;gap:10px;margin-left:8px}
.vp-h{font-size:11px;font-weight:700;display:flex;align-items:center;gap:4px}
.vp-h.india{color:#2196F3}.vp-h.pakistan{color:#4CAF50}
.vp-bar-sm{width:60px;height:4px;background:#1a2d45;border-radius:2px;overflow:hidden;display:inline-block}
.vp-fill-sm{height:100%;border-radius:2px;transition:width .3s}
.vp-fill-sm.india{background:#2196F3}.vp-fill-sm.pakistan{background:#4CAF50}

/* Map */
#map{position:fixed;top:48px;left:0;right:0;bottom:0}

/* Battle Feed — left sidebar */
.feed-col{position:fixed;top:48px;bottom:0;width:260px;z-index:999;
  background:rgba(6,10,18,.55);backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px);
  font-family:'JetBrains Mono','Courier New','Consolas','Liberation Mono',monospace;font-size:12px;line-height:1.5;
  overflow-y:auto;padding:6px 12px;scroll-behavior:smooth}
.feed-col::-webkit-scrollbar{width:4px}
.feed-col::-webkit-scrollbar-track{background:transparent}
.feed-col::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:3px}
#feed-left{left:0;border-right:1px solid rgba(100,150,200,.2)}
.feed-col-label{font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;
  padding:2px 0 4px 0;opacity:.5;text-align:center;color:#7eb8da}
.feed-line{padding:1px 0;opacity:0;animation:feedIn .15s ease-out forwards;white-space:pre-wrap;word-break:break-word}
@keyframes feedIn{0%{opacity:0;transform:translateX(-8px)}100%{opacity:1;transform:translateX(0)}}
.feed-tag{float:right;font-size:9px;font-weight:700;letter-spacing:1px;opacity:.4}
.feed-phase{padding:4px 0 2px 0;font-weight:700;letter-spacing:2px;font-size:11px;
  border-bottom:1px solid rgba(255,255,255,.06);margin-top:4px}
.feed-sep{border-top:1px solid rgba(255,255,255,.04);margin:3px 0;height:0}
.feed-cursor{display:inline-block;width:6px;height:12px;margin-left:2px;background:#7eb8da;
  animation:fblink 1s step-end infinite;vertical-align:middle}
@keyframes fblink{0%,100%{opacity:1}50%{opacity:0}}
.fc-red{color:#ff4444}.fc-green{color:#44ee44}.fc-amber{color:#ffaa22}
.fc-cyan{color:#44ddff}.fc-white{color:#ccddee}.fc-orange{color:#ff8844}
.fc-purple{color:#cc88ff}.fc-teal{color:#66ccaa}.fc-yellow{color:#ffcc00}
.fc-dim{color:#556677}
.leaflet-container{background:#0a0a1a}
.leaflet-control-layers{background:#111d2e!important;color:#aab!important;border:1px solid #1a2d45!important;font-size:11px}
.leaflet-control-layers label{color:#99a}
.leaflet-control-zoom a{background:#111d2e!important;color:#7eb8da!important;border-color:#1a2d45!important}
.leaflet-tooltip{background:#111d2e;color:#ccd;border:1px solid #2a4a6f;font-size:11px;padding:4px 8px;border-radius:3px;box-shadow:0 2px 8px rgba(0,0,0,.5)}
.leaflet-tooltip-top:before{border-top-color:#2a4a6f}.leaflet-tooltip-bottom:before{border-bottom-color:#2a4a6f}
.leaflet-tile-pane{filter:brightness(.6) invert(1) contrast(3) hue-rotate(200deg) saturate(.3) brightness(.7)}

/* Icons */
.unit-icon,.airbase-icon,.combat-pulse,.anim-icon{background:transparent!important;border:none!important}
.combat-dot{width:14px;height:14px;background:rgba(255,68,68,.6);border:2px solid #ff4444;border-radius:50%;animation:cpulse 1.5s ease-out infinite}
@keyframes cpulse{0%{box-shadow:0 0 0 0 rgba(255,68,68,.5)}70%{box-shadow:0 0 0 12px rgba(255,68,68,0)}100%{box-shadow:0 0 0 0 rgba(255,68,68,0)}}

/* Explosion */
.boom-wrap{position:relative;width:80px;height:80px}
.boom-core{position:absolute;inset:15px;border-radius:50%;
  background:radial-gradient(circle,#fff 0%,rgba(255,220,0,1) 20%,rgba(255,120,0,.9) 45%,rgba(255,0,0,.4) 70%,transparent 100%);
  animation:boomCore 1.1s ease-out forwards}
.boom-ring{position:absolute;inset:0;border-radius:50%;border:2px solid rgba(255,200,0,.7);
  animation:boomRing 1s ease-out forwards}
.boom-smoke{position:absolute;inset:-10px;border-radius:50%;
  background:radial-gradient(circle,rgba(80,60,40,.5) 0%,rgba(40,30,20,.2) 50%,transparent 80%);
  animation:boomSmoke 1.5s ease-out forwards}
@keyframes boomCore{0%{transform:scale(0);opacity:1}30%{transform:scale(1.2);opacity:1}60%{transform:scale(1);opacity:.7}100%{transform:scale(.5);opacity:0}}
@keyframes boomRing{0%{transform:scale(0);opacity:1;border-width:3px}100%{transform:scale(3);opacity:0;border-width:1px}}
@keyframes boomSmoke{0%{transform:scale(0);opacity:0}30%{transform:scale(.5);opacity:.6}100%{transform:scale(2.5);opacity:0}}
.boom-sm{width:36px;height:36px;border-radius:50%;
  background:radial-gradient(circle,#fff 0%,rgba(255,180,0,.9) 30%,rgba(255,100,0,.5) 60%,transparent 100%);
  animation:boomSm .7s ease-out forwards}
@keyframes boomSm{0%{transform:scale(0);opacity:1}40%{transform:scale(1.1);opacity:.9}100%{transform:scale(1.5);opacity:0}}

/* Ground flash */
.ground-flash-wrap{position:relative;width:60px;height:60px}
.ground-flash-ring{position:absolute;inset:0;border-radius:50%;border:3px solid rgba(255,200,0,.8);
  animation:gflash 1s ease-out forwards}
.ground-flash-core{position:absolute;inset:15px;border-radius:50%;
  background:radial-gradient(circle,rgba(255,200,0,.9) 0%,rgba(255,120,0,.5) 60%,transparent 100%);
  animation:gcore .8s ease-out forwards}
@keyframes gflash{0%{transform:scale(0);opacity:1;border-width:3px}50%{transform:scale(1);opacity:.8}100%{transform:scale(2.5);opacity:0;border-width:1px}}
@keyframes gcore{0%{transform:scale(0);opacity:1}30%{transform:scale(1);opacity:.8}100%{transform:scale(.3);opacity:0}}

/* SAM interception */
.intercept-wrap{position:relative;width:60px;height:60px}
.intercept-core{position:absolute;inset:10px;border-radius:50%;
  background:radial-gradient(circle,#fff 0%,rgba(100,200,255,1) 30%,rgba(50,150,255,.6) 60%,transparent 100%);
  animation:boomCore .8s ease-out forwards}
.intercept-ring{position:absolute;inset:0;border-radius:50%;border:2px solid rgba(100,200,255,.7);
  animation:boomRing .8s ease-out forwards}
.sam-miss-flash{width:24px;height:24px;border-radius:50%;
  background:radial-gradient(circle,rgba(200,200,255,.7) 0%,rgba(100,150,255,.3) 60%,transparent 100%);
  animation:boomSm .5s ease-out forwards}

/* Missile exhaust */
.missile-exhaust{position:absolute;left:-8px;top:50%;transform:translateY(-50%);
  width:12px;height:6px;border-radius:0 50% 50% 0;
  background:linear-gradient(90deg,transparent 0%,rgba(255,160,0,.9) 40%,rgba(255,255,200,1) 100%);
  animation:exhaust .15s ease-in-out infinite alternate;filter:blur(0.5px)}
@keyframes exhaust{0%{width:8px;opacity:.7}100%{width:14px;opacity:1}}

/* Engagement labels */
.engage-label{font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  white-space:nowrap;text-align:center;color:#ccddee;
  text-shadow:0 0 8px #000,0 0 16px #000,0 1px 3px rgba(0,0,0,.9);
  animation:labelIn .4s ease-out forwards}
.kill-label{font-size:14px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;
  white-space:nowrap;text-align:center;color:#ff4444;
  text-shadow:0 0 12px rgba(255,0,0,.7),0 0 24px rgba(255,0,0,.4),0 1px 3px rgba(0,0,0,.9);
  animation:killIn .6s ease-out forwards}
.intercept-label{font-size:14px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;
  white-space:nowrap;text-align:center;color:#44aaff;
  text-shadow:0 0 12px rgba(0,150,255,.7),0 0 24px rgba(0,150,255,.4),0 1px 3px rgba(0,0,0,.9);
  animation:killIn .6s ease-out forwards}
@keyframes labelIn{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}
@keyframes killIn{0%{opacity:0;transform:scale(.5)}50%{opacity:1;transform:scale(1.2)}100%{opacity:1;transform:scale(1)}}

/* Drone */
.drone-swarm-wrap{position:relative;width:60px;height:60px}
.drone-dot{position:absolute;width:4px;height:4px;border-radius:50%;background:#aa66ff;
  box-shadow:0 0 4px #aa66ff,0 0 8px rgba(170,102,255,.5);
  animation:swarmBuzz .6s ease-in-out infinite alternate}
.drone-dot:nth-child(2){animation-delay:.1s}.drone-dot:nth-child(3){animation-delay:.2s}
.drone-dot:nth-child(4){animation-delay:.15s}.drone-dot:nth-child(5){animation-delay:.25s}
.drone-dot:nth-child(6){animation-delay:.05s}.drone-dot:nth-child(7){animation-delay:.3s}
.drone-dot:nth-child(8){animation-delay:.12s}
@keyframes swarmBuzz{0%{transform:translate(0,0)}100%{transform:translate(3px,2px)}}
.drone-strike-flash{width:30px;height:30px;border-radius:50%;
  background:radial-gradient(circle,#fff 0%,rgba(170,102,255,.9) 30%,rgba(130,60,220,.4) 60%,transparent 100%);
  animation:droneFlash .6s ease-out forwards}
@keyframes droneFlash{0%{transform:scale(0);opacity:1}40%{transform:scale(1.2);opacity:.9}100%{transform:scale(1.8);opacity:0}}
.drone-label{font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  white-space:nowrap;text-align:center;color:#cc99ff;
  text-shadow:0 0 8px rgba(130,60,220,.7),0 0 16px rgba(130,60,220,.4),0 1px 3px rgba(0,0,0,.9);
  animation:labelIn .4s ease-out forwards}

/* Helicopter */
.heli-rotor-wrap{position:relative;width:40px;height:40px}
.heli-body{position:absolute;inset:10px;font-size:18px;text-align:center;line-height:20px}
.heli-rotor{position:absolute;top:2px;left:50%;width:36px;height:2px;margin-left:-18px;
  background:rgba(102,204,170,.6);border-radius:1px;animation:rotorSpin .15s linear infinite}
@keyframes rotorSpin{0%{transform:rotate(0)}100%{transform:rotate(180deg)}}
.heli-strafe-flash{width:24px;height:24px;border-radius:50%;
  background:radial-gradient(circle,#fff 0%,rgba(102,204,170,.8) 40%,rgba(60,180,140,.3) 70%,transparent 100%);
  animation:heliFlash .5s ease-out forwards}
@keyframes heliFlash{0%{transform:scale(0);opacity:1}50%{transform:scale(1);opacity:.8}100%{transform:scale(1.5);opacity:0}}
.heli-label{font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  white-space:nowrap;text-align:center;color:#66ccaa;
  text-shadow:0 0 8px rgba(60,180,140,.7),0 0 16px rgba(60,180,140,.4),0 1px 3px rgba(0,0,0,.9);
  animation:labelIn .4s ease-out forwards}

/* SF */
.sf-ping-wrap{position:relative;width:50px;height:50px}
.sf-ping-ring{position:absolute;inset:0;border-radius:50%;border:2px solid rgba(204,136,255,.7);
  animation:sfPing 1.2s ease-out forwards}
.sf-ping-core{position:absolute;inset:18px;border-radius:50%;
  background:radial-gradient(circle,rgba(204,136,255,.9) 0%,rgba(160,80,220,.4) 60%,transparent 100%);
  animation:sfCore .8s ease-out forwards}
@keyframes sfPing{0%{transform:scale(0);opacity:1;border-width:2px}60%{opacity:.7}100%{transform:scale(2.5);opacity:0;border-width:1px}}
@keyframes sfCore{0%{transform:scale(0);opacity:1}40%{transform:scale(1.2);opacity:.8}100%{transform:scale(0);opacity:0}}
.sf-label{font-size:12px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  white-space:nowrap;text-align:center;color:#cc88ff;
  text-shadow:0 0 8px rgba(160,80,220,.7),0 0 16px rgba(160,80,220,.4),0 1px 3px rgba(0,0,0,.9);
  animation:sfFadeIn .6s ease-out forwards}
@keyframes sfFadeIn{0%{opacity:0;transform:translateY(6px)}100%{opacity:1;transform:translateY(0)}}

/* Float text */
.float-text{font-size:13px;font-weight:800;letter-spacing:1px;text-transform:uppercase;
  white-space:nowrap;text-align:center;
  text-shadow:0 0 10px rgba(0,0,0,.9),0 0 20px rgba(0,0,0,.7),0 1px 3px rgba(0,0,0,.9);
  animation:floatUp 3.2s ease-out forwards;pointer-events:none}
.float-text.ft-large{font-size:16px;letter-spacing:1.5px}
.float-text.ft-small{font-size:11px;font-weight:700}
.float-text.ft-red{color:#ff4444}.float-text.ft-green{color:#44ee44}.float-text.ft-amber{color:#ffaa22}
.float-text.ft-cyan{color:#44ddff}.float-text.ft-orange{color:#ff8844}.float-text.ft-purple{color:#cc88ff}.float-text.ft-teal{color:#66ccaa}
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}50%{opacity:.95}80%{opacity:.5}100%{opacity:0;transform:translateY(-50px)}}

/* CRT */
#crt-overlay{position:fixed;inset:0;pointer-events:none;z-index:2000;mix-blend-mode:overlay;
  background:repeating-linear-gradient(0deg,rgba(0,0,0,.15) 0px,rgba(0,0,0,.15) 1px,transparent 1px,transparent 3px);
  display:none}
#crt-overlay.active{display:block}

/* ── Faction selection overlay ── */
#faction-overlay{position:fixed;inset:0;z-index:3000;background:rgba(5,8,18,.97);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px}
#faction-overlay .fo-classify{font-size:10px;letter-spacing:5px;color:#ff3333;text-transform:uppercase;
  font-weight:700;opacity:.7;animation:foBlink 2s step-end infinite}
@keyframes foBlink{0%,100%{opacity:.7}50%{opacity:.3}}
#faction-overlay h1{font-size:22px;font-weight:800;letter-spacing:5px;color:#7eb8da;text-transform:uppercase;
  text-shadow:0 0 30px rgba(126,184,218,.2);margin:0}
#faction-overlay .fo-subtitle{font-size:11px;letter-spacing:3px;color:#445566;text-transform:uppercase;margin-bottom:10px}
#faction-overlay p{font-size:12px;color:#556;max-width:500px;text-align:center;line-height:1.6}
.faction-cards{display:flex;gap:24px}
.faction-card{width:240px;padding:30px 20px;border:2px solid #1e3a5f;border-radius:8px;
  background:#0f1729;cursor:pointer;text-align:center;transition:all .2s}
.faction-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,.5)}
.faction-card.india{border-color:rgba(33,150,243,.4)}
.faction-card.india:hover{background:#0f1d35;border-color:#2196F3;box-shadow:0 8px 24px rgba(33,150,243,.2)}
.faction-card.pakistan{border-color:rgba(76,175,80,.4)}
.faction-card.pakistan:hover{background:#0f2518;border-color:#4CAF50;box-shadow:0 8px 24px rgba(76,175,80,.2)}
.faction-card .flag{font-size:48px;margin-bottom:12px}
.faction-card .fname{font-size:16px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px}
.faction-card.india .fname{color:#2196F3}
.faction-card.pakistan .fname{color:#4CAF50}
.faction-card .fdesc{font-size:10px;color:#667;line-height:1.5}
.faction-card .fkey-systems{margin-top:8px;font-size:9px;color:#556;letter-spacing:1px;text-transform:uppercase;line-height:1.8}
/* Force briefing overlay (after faction select) */
#force-briefing{position:fixed;inset:0;z-index:3500;background:rgba(5,8,18,.97);
  display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px}
#force-briefing.active{display:flex}
#force-briefing h2{font-size:18px;font-weight:800;letter-spacing:4px;color:#7eb8da;text-transform:uppercase}
.fb-stats{display:flex;gap:24px;margin-top:8px}
.fb-stat{text-align:center;min-width:80px}
.fb-stat .fbs-value{font-size:28px;font-weight:800;color:#7eb8da}
.fb-stat .fbs-label{font-size:9px;letter-spacing:2px;color:#556;text-transform:uppercase;margin-top:2px}
.fb-loading{font-size:11px;letter-spacing:3px;color:#445566;text-transform:uppercase;margin-top:16px;
  animation:promptPulse 2s ease-in-out infinite}
@keyframes promptPulse{0%,100%{opacity:.3}50%{opacity:.8}}

/* ── Orders Panel ── */
#orders-panel{position:fixed;top:48px;right:0;bottom:0;width:340px;z-index:999;
  background:rgba(8,12,22,.85);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
  border-left:1px solid #1e3a5f;display:none;flex-direction:column;font-size:11px;overflow:hidden}
#orders-panel.active{display:flex}
.op-header{padding:8px 12px;background:#0f1729;border-bottom:1px solid #1e3a5f;
  font-size:12px;font-weight:700;letter-spacing:2px;color:#7eb8da;text-transform:uppercase;
  display:flex;justify-content:space-between;align-items:center}
.op-header .order-count{font-size:11px;color:#556}
.domain-tabs{display:flex;flex-wrap:wrap;gap:3px;padding:6px 8px;border-bottom:1px solid #1a2d45}
.domain-tabs button{background:#1a2744;border:1px solid #2a4a6f;color:#7eb8da;padding:3px 7px;
  cursor:pointer;border-radius:3px;font-size:10px;font-family:inherit;letter-spacing:1px;font-weight:600}
.domain-tabs button:hover{background:#243654}
.domain-tabs button.active{background:#2a5a3f;border-color:#4CAF50;color:#fff}
/* Search */
#unit-search{width:100%;background:#0d1520;border:1px solid #1a2d45;color:#ccd;padding:4px 8px;
  border-radius:3px;font-size:10px;font-family:inherit;margin:4px 0;box-sizing:border-box}
#unit-search::placeholder{color:#445}
/* Quick presets */
.preset-bar{display:flex;gap:3px;padding:2px 8px;flex-wrap:wrap}
.preset-btn{background:#1a2744;border:1px solid #2a4a6f;color:#ffaa22;padding:2px 6px;
  cursor:pointer;border-radius:3px;font-size:9px;font-family:inherit;letter-spacing:1px;font-weight:700}
.preset-btn:hover{background:#2a3a54;border-color:#ffaa22}
/* Expenditure */
#planned-expenditure{font-size:10px;color:#ffaa22;letter-spacing:1px;padding:4px 8px;text-align:center;
  border-top:1px solid #1a2d45;display:none}
#planned-expenditure.visible{display:block}
#unit-list{flex:1;overflow-y:auto;padding:4px 8px;min-height:0}
#unit-list::-webkit-scrollbar{width:4px}
#unit-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
.unit-card{padding:6px 8px;margin:3px 0;border:1px solid #1a2d45;border-radius:4px;cursor:pointer;
  background:#0d1520;transition:background .15s}
.unit-card:hover{background:#152030}
.unit-card.selected{border-color:#4CAF50;background:#12251a}
.unit-card.disabled{opacity:.35;pointer-events:none}
.unit-card .uc-name{font-weight:700;font-size:11px;color:#ccd;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.unit-card .uc-meta{display:flex;gap:6px;align-items:center;font-size:10px;color:#667}
.unit-card .uc-type{background:#1a2744;padding:1px 5px;border-radius:2px;font-size:9px;color:#7eb8da}
.unit-card .uc-str{display:inline-block;width:40px;height:4px;background:#1a2d45;border-radius:2px;overflow:hidden;vertical-align:middle}
.unit-card .uc-str-fill{height:100%;border-radius:2px}
.unit-card .uc-status{font-size:9px;padding:1px 4px;border-radius:2px;font-weight:600}
.uc-status.ready{background:#1a3a2a;color:#4CAF50}.uc-status.damaged{background:#3a2a1a;color:#ff8844}
.uc-status.destroyed{background:#3a1a1a;color:#ff4444}.uc-status.retreating{background:#2a2a3a;color:#8888cc}

/* Mission form */
#mission-form{border-top:1px solid #1a2d45;padding:8px;display:none;flex-direction:column;gap:6px}
#mission-form.active{display:flex}
#mission-form label{font-size:10px;color:#667;letter-spacing:1px;text-transform:uppercase}
#mission-form select,#mission-form input[type=number]{background:#1a2744;border:1px solid #2a4a6f;
  color:#ccd;padding:4px 6px;border-radius:3px;font-size:11px;font-family:inherit;width:100%}
#mission-form select option{background:#1a2744}
.mf-row{display:flex;gap:6px;align-items:center}
.mf-row>*{flex:1}
#btn-add-order{background:#2a5a3f;border:1px solid #4CAF50;color:#fff;padding:5px;
  border-radius:3px;cursor:pointer;font-family:inherit;font-size:11px;font-weight:700;letter-spacing:1px}
#btn-add-order:hover{background:#3a6a4f}
#btn-pick-map{background:#1a2744;border:1px solid #2a4a6f;color:#7eb8da;padding:4px 8px;
  border-radius:3px;cursor:pointer;font-size:10px;font-family:inherit}
#btn-pick-map:hover{background:#243654}
#btn-pick-map.picking{background:#5a3a1a;border-color:#ff8844;color:#ff8844}

/* Queued orders */
#queued-orders{border-top:1px solid #1a2d45;max-height:200px;overflow-y:auto;padding:4px 8px}
#queued-orders::-webkit-scrollbar{width:4px}
#queued-orders::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
.queued-label{font-size:10px;color:#556;letter-spacing:1px;padding:4px 0;text-transform:uppercase}
.q-order{display:flex;align-items:center;gap:6px;padding:3px 6px;margin:2px 0;
  background:#0d1520;border:1px solid #1a2d45;border-radius:3px;font-size:10px}
.q-order .q-cat{background:#1a2744;padding:1px 4px;border-radius:2px;font-weight:700;color:#7eb8da;font-size:9px}
.q-order .q-desc{flex:1;color:#aab;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.q-order .q-remove{color:#ff4444;cursor:pointer;font-weight:700;padding:0 2px}
.q-order .q-remove:hover{color:#ff6666}

/* Submit button */
#submit-btn{margin:8px;padding:10px;background:linear-gradient(135deg,#2a5a3f,#1a4a2f);
  border:2px solid #4CAF50;color:#fff;font-size:13px;font-weight:800;letter-spacing:2px;
  text-transform:uppercase;border-radius:4px;cursor:pointer;font-family:inherit;transition:all .2s}
#submit-btn:hover{background:linear-gradient(135deg,#3a6a4f,#2a5a3f);box-shadow:0 0 16px rgba(76,175,80,.3)}
#submit-btn:disabled{opacity:.3;cursor:not-allowed}

/* Waiting overlay */
#waiting-overlay{position:fixed;inset:0;z-index:2500;background:rgba(5,8,18,.7);
  display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px}
#waiting-overlay.active{display:flex}
#waiting-overlay .wo-text{font-size:14px;font-weight:700;letter-spacing:3px;color:#7eb8da;text-transform:uppercase}
.spinner{width:32px;height:32px;border:3px solid #1e3a5f;border-top-color:#7eb8da;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Game over overlay */
#gameover-overlay{position:fixed;inset:0;z-index:3000;background:rgba(5,8,18,.9);
  display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px}
#gameover-overlay.active{display:flex}
#gameover-overlay h1{font-size:28px;font-weight:800;letter-spacing:4px;text-transform:uppercase}
#gameover-overlay .go-vp{font-size:14px;color:#778;letter-spacing:2px}
#gameover-overlay button{background:#1a2744;border:1px solid #2a4a6f;color:#7eb8da;padding:10px 24px;
  border-radius:4px;cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;letter-spacing:2px}

/* ── Cost-of-War Report (Game Over) ── */
.cost-report{max-width:840px;width:90%;max-height:85vh;overflow-y:auto;padding:32px;
  background:linear-gradient(135deg,rgba(12,20,35,.95),rgba(8,14,24,.98));
  border:1px solid #2a4a6f;border-radius:8px;box-shadow:0 0 60px rgba(33,150,243,.15)}
.cost-report h2{font-size:16px;letter-spacing:4px;text-transform:uppercase;color:#7eb8da;text-align:center;margin-bottom:4px}
.cost-report .subtitle{font-size:11px;color:#556;text-align:center;margin-bottom:20px;letter-spacing:2px}
.cost-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
.cost-card{background:rgba(15,23,41,.8);border:1px solid #1e3a5f;border-radius:6px;padding:16px}
.cost-card.india{border-top:3px solid #2196F3}.cost-card.pakistan{border-top:3px solid #4CAF50}
.cost-card h3{font-size:12px;letter-spacing:2px;text-transform:uppercase;margin-bottom:12px}
.cost-card.india h3{color:#2196F3}.cost-card.pakistan h3{color:#4CAF50}
.cost-row{display:flex;justify-content:space-between;padding:3px 0;font-size:11px;border-bottom:1px solid rgba(255,255,255,.04)}
.cost-row .label{color:#778}.cost-row .value{font-weight:700;color:#ccd}
.cost-row .value.red{color:#ff4444}.cost-row .value.green{color:#44ee44}.cost-row .value.amber{color:#ffaa22}
.cost-big{font-size:22px;font-weight:800;text-align:center;margin:8px 0}
.cost-big.india{color:#2196F3}.cost-big.pakistan{color:#4CAF50}
.cost-exchange{text-align:center;padding:16px;background:rgba(15,23,41,.9);border:1px solid #1e3a5f;border-radius:6px;margin-bottom:16px}
.cost-exchange .ratio{font-size:28px;font-weight:800;letter-spacing:2px}
.cost-exchange .ratio.india{color:#2196F3}.cost-exchange .ratio.pakistan{color:#4CAF50}
.cost-exchange .vs{font-size:12px;color:#556;margin:0 12px}
.cost-bar-row{display:flex;align-items:center;gap:6px;margin:3px 0;font-size:10px}
.cost-bar-label{width:70px;color:#778;text-align:right}
.cost-bar-track{flex:1;height:6px;background:#0a1020;border-radius:3px;overflow:hidden}
.cost-bar-fill{height:100%;border-radius:3px;transition:width .5s}
.cost-bar-fill.india{background:#2196F3}.cost-bar-fill.pakistan{background:#4CAF50}
.cost-bar-fill.red{background:#ff4444}.cost-bar-fill.amber{background:#ffaa22}
.cost-bar-value{width:55px;color:#99a;font-size:10px}
.cost-close{display:block;margin:16px auto 0;background:#1a2744;border:1px solid #2a4a6f;
  color:#7eb8da;padding:8px 24px;border-radius:4px;cursor:pointer;font-size:11px;
  letter-spacing:2px;text-transform:uppercase;font-family:inherit}
.cost-close:hover{background:#243654}

/* ── Presentation Mode ── */
body.presentation .hdr-controls #crt-btn,body.presentation .hdr-controls #sound-btn{display:none}
body.presentation .title{font-size:15px}
body.presentation .vp-h{font-size:13px}
body.presentation .info-pill{font-size:13px}
body.presentation .feed-col{font-size:13px}
body.presentation .feed-line{font-size:13px}
body.presentation #orders-panel{font-size:12px}
body.presentation .unit-card .uc-name{font-size:12px}
body.presentation #submit-btn{font-size:15px}
body.presentation #faction-overlay h1{font-size:28px}
body.presentation .faction-card .fname{font-size:20px}
body.presentation .faction-card .fdesc{font-size:12px}
body.presentation .cost-report{font-size:13px}
body.presentation .cost-big{font-size:28px}
body.presentation #gameover-overlay h1{font-size:36px}

/* Controls in header */
.hdr-controls{display:flex;align-items:center;gap:5px}
.hdr-controls button{background:#1a2744;border:1px solid #2a4a6f;color:#7eb8da;width:30px;height:26px;
  cursor:pointer;border-radius:3px;font-size:12px;display:flex;align-items:center;justify-content:center}
.hdr-controls button:hover{background:#243654}
.hdr-controls button.active{background:#2a5a3f;border-color:#4CAF50}
</style>
</head>
<body>

<div id="header">
  <div class="title">Wargame — <span id="hdr-faction">Human</span> vs AI</div>
  <div class="vp-header">
    <span class="vp-h india">IND <div class="vp-bar-sm"><div class="vp-fill-sm india" id="vp-india-bar" style="width:50%"></div></div> <span id="india-vp">0</span></span>
    <span class="vp-h pakistan">PAK <div class="vp-bar-sm"><div class="vp-fill-sm pakistan" id="vp-pak-bar" style="width:50%"></div></div> <span id="pakistan-vp">0</span></span>
  </div>
  <div style="display:flex;align-items:center;gap:6px;margin-left:6px">
    <span style="font-size:10px;font-weight:700;color:#2196F3">$<span id="india-cost">0</span>M</span>
    <span style="font-size:9px;color:#556;letter-spacing:1px">LOST</span>
    <span style="font-size:10px;font-weight:700;color:#4CAF50">$<span id="pakistan-cost">0</span>M</span>
    <span style="font-size:8px;color:#445;margin-left:2px;letter-spacing:1px" id="exchange-display"></span>
  </div>
  <div class="info">
    <span class="info-pill" id="turn-display">Turn 0</span>
    <span class="info-pill" id="day-display">Day 1 Pre-war</span>
    <span class="info-pill" id="weather-display">Clear</span>
  </div>
  <div class="hdr-controls" style="margin-left:auto">
    <button id="sound-btn" onclick="toggleSound()" title="Toggle sound">&#128264;</button>
    <button id="crt-btn" onclick="toggleCRT()" title="CRT effect">CRT</button>
  </div>
</div>

<div id="phase-overlay"></div>
<div id="map"></div>
<div id="crt-overlay"></div>

<div class="feed-col" id="feed-left"><div class="feed-col-label">BATTLE FEED</div><span class="feed-cursor"></span></div>

<div id="orders-panel">
  <div class="op-header">TURN <span id="op-turn">1</span> ORDERS <span class="order-count">(<span id="op-count">0</span> queued)</span></div>
  <div class="domain-tabs" id="domain-tabs"></div>
  <div class="preset-bar" id="preset-bar" style="display:none">
    <button class="preset-btn" onclick="applyPreset('sead')" title="SEAD Package: Strike enemy SAM sites">SEAD PKG</button>
    <button class="preset-btn" onclick="applyPreset('deep_strike')" title="Deep Strike: Hit enemy airbases">DEEP STRIKE</button>
    <button class="preset-btn" onclick="applyPreset('air_sup')" title="Air Superiority: CAP + Sweep">AIR SUP</button>
  </div>
  <input type="text" id="unit-search" placeholder="Search units..." oninput="filterUnitList()">
  <div id="unit-list"></div>
  <div id="mission-form">
    <div id="mf-unit-name" style="font-weight:700;color:#ccd;padding-bottom:4px"></div>
    <label>Mission</label>
    <select id="mf-mission"></select>
    <label>Target</label>
    <div class="mf-row">
      <select id="mf-target"></select>
      <button id="btn-pick-map" onclick="startMapPick()">MAP</button>
    </div>
    <div id="mf-extra-row" class="mf-row" style="display:none">
      <div style="flex:1"><label id="mf-extra-label">Count</label><input type="number" id="mf-extra" min="1" max="100" value="2"></div>
      <div style="flex:1"><label id="mf-posture-label" style="display:none">Posture</label><select id="mf-posture" style="display:none"></select></div>
    </div>
    <button id="btn-add-order" onclick="addOrder()">+ ADD ORDER</button>
  </div>
  <div id="queued-orders"><div class="queued-label">QUEUED ORDERS</div></div>
  <div id="planned-expenditure">PLANNED EXPENDITURE: $0M</div>
  <button id="submit-btn" onclick="submitTurn()">SUBMIT TURN</button>
</div>

<div id="faction-overlay">
  <div class="fo-classify">&#9608; WARGAME COMMAND INTERFACE &#9608;</div>
  <h1>India-Pakistan Wargame</h1>
  <div class="fo-subtitle">Full-Spectrum Theatre Simulation</div>
  <p>Select your faction to assume operational command. Your AI opponent will control opposing forces across all domains: air, ground, missile, and special operations.</p>
  <div class="faction-cards">
    <div class="faction-card india" onclick="selectFaction('india')">
      <div class="flag">&#127470;&#127475;</div>
      <div class="fname">India</div>
      <div class="fdesc">Larger conventional force with qualitative edge in airpower and precision strike.</div>
      <div class="fkey-systems">Su-30MKI | Rafale | BrahMos<br>S-400 | Akash | Phalcon AWACS</div>
    </div>
    <div class="faction-card pakistan" onclick="selectFaction('pakistan')">
      <div class="flag">&#127477;&#127472;</div>
      <div class="fname">Pakistan</div>
      <div class="fdesc">Asymmetric strategy leveraging Chinese systems and tactical nuclear deterrence.</div>
      <div class="fkey-systems">JF-17 | F-16 | Babur ALCM<br>HQ-9 | LY-80 | Erieye AEW</div>
    </div>
  </div>
</div>

<div id="force-briefing">
  <h2 id="fb-title">YOUR FORCES</h2>
  <div class="fb-stats" id="fb-stats"></div>
  <div class="fb-loading" id="fb-loading">INITIALIZING THEATRE...</div>
</div>

<div id="waiting-overlay"><div class="spinner"></div><div class="wo-text">AI OPPONENT PLANNING...</div></div>
<div id="gameover-overlay"><h1 id="go-title"></h1><div class="go-vp" id="go-vp"></div><div id="go-cost-report" style="display:none;max-height:60vh;overflow-y:auto"></div><button onclick="location.reload()" style="margin-top:12px">NEW GAME</button></div>

<script>
// ── Presentation Mode ──
var presentationMode = new URLSearchParams(window.location.search).has('presentation');
if(presentationMode) {
  document.body.classList.add('presentation');
  document.documentElement.requestFullscreen && document.documentElement.requestFullscreen().catch(function(){});
}

// ── State ──
var ws, myFaction, animSpeed = 1;
var gameState = null, unitRoster = [], staticData = null, targets = [];
var pendingOrders = {};
var currentTurn = 0, maxTurns = 16;
var selectedDomain = null, selectedUnit = null, mapPicking = false;
var map, unitLy, combatLy, samLy, riverLy, cityLy, airbaseLy, locLy, sectorLy, animLy;
var currentAnim = null;
var catSize = {ground:10,aircraft:7,missile:6,air_defense:6,artillery:7,helicopter:6,drone:5,special_forces:5,isr:5};
var soundOn = true;

// Domain config
var DOMAINS = [
  {key:'missile',cat:'missile',label:'MSL',missions:null,idField:'battery_id',extraField:'missiles',extraLabel:'Missiles'},
  {key:'aircraft',cat:'aircraft',label:'AIR',missions:['cap','sweep','escort','strike','sead','cas'],idField:'squadron_id',extraField:'aircraft',extraLabel:'Aircraft'},
  {key:'drone',cat:'drone',label:'UAV',missions:['isr','strike','sead','loitering'],idField:'unit_id',extraField:null},
  {key:'artillery',cat:'artillery',label:'ARTY',missions:['bombardment','suppression','counter_battery','smoke'],idField:'battery_id',extraField:'rounds',extraLabel:'Rounds'},
  {key:'helicopter',cat:'helicopter',label:'HELI',missions:['attack','cas','air_assault','scout','csar'],idField:'unit_id',extraField:'helicopters',extraLabel:'Helicopters'},
  {key:'ground',cat:'ground',label:'GND',missions:['attack','defend','move','withdraw','reserve'],idField:'unit_id',extraField:null,hasPosture:true,postures:['assault','probe','exploitation','defend','delay']},
  {key:'special_forces',cat:'special_forces',label:'SF',missions:['raid','recon','sabotage','da','sr'],idField:'unit_id',extraField:null},
  {key:'ew',cat:['isr','air_defense','other'],label:'EW',missions:['jam_radar','jam_comms','gps_denial','cyber','sigint'],idField:'unit_id',extraField:null}
];
var MISSILE_TARGET_TYPES = ['airbase','sam_site','radar','c2','logistics','ground_unit'];
var ORDER_KEYS = {missile:'missile_strikes',aircraft:'air_missions',drone:'drone_missions',
  artillery:'artillery_missions',helicopter:'helicopter_missions',ground:'ground_orders',
  special_forces:'sf_missions',ew:'ew_missions'};

// Phase config (from replay)
var PHASE_DEFS = [
  {match:/^missile/,label:'MISSILE STRIKES',color:'#ff4444',type:'missile'},
  {match:/^air/,label:'AIR OPERATIONS',color:'#4499ff',type:'air'},
  {match:/^drone/,label:'DRONE OPS',color:'#aa66ff',type:'drone'},
  {match:/^artiller/,label:'ARTILLERY FIRE',color:'#ff8844',type:'arty'},
  {match:/^heli/,label:'HELICOPTER OPS',color:'#66ccaa',type:'heli'},
  {match:/^ground/,label:'GROUND COMBAT',color:'#ffcc00',type:'ground'},
  {match:/^special/,label:'SPECIAL FORCES',color:'#cc88ff',type:'sf'},
  {match:/./,label:'COMBAT',color:'#aaaaaa',type:'ground'}
];
function phaseFor(e){for(var i=0;i<PHASE_DEFS.length;i++){if(PHASE_DEFS[i].match.test(e.phase))return PHASE_DEFS[i];}return PHASE_DEFS[PHASE_DEFS.length-1];}

// ── WebSocket ──
function connectWS(){
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/ws');
  ws.onopen = function(){ console.log('WS connected'); };
  ws.onclose = function(){ console.log('WS closed'); setTimeout(connectWS, 2000); };
  ws.onerror = function(e){ console.error('WS error', e); };
  ws.onmessage = function(e){
    var msg = JSON.parse(e.data);
    handleMessage(msg);
  };
}

function sendMsg(type, data){
  if(ws && ws.readyState === 1) ws.send(JSON.stringify({type:type, ...data}));
}

function handleMessage(msg){
  switch(msg.type){
    case 'game_init':
      myFaction = msg.faction;
      maxTurns = msg.max_turns;
      gameState = msg.game_state;
      unitRoster = msg.unit_roster;
      staticData = msg.static;
      targets = msg.targets;
      document.getElementById('hdr-faction').textContent = myFaction.toUpperCase();
      initMap();
      drawStatic();
      if(msg.initial_turn) showTurnState(msg.initial_turn);
      document.getElementById('orders-panel').classList.add('active');
      showForceBriefing();
      break;
    case 'awaiting_orders':
      currentTurn = msg.turn;
      gameState = msg.game_state;
      unitRoster = msg.unit_roster;
      targets = msg.targets;
      document.getElementById('op-turn').textContent = currentTurn;
      document.getElementById('turn-display').textContent = 'Turn ' + currentTurn + '/' + maxTurns;
      pendingOrders = {};
      renderQueuedOrders();
      enableOrdersPanel();
      if(selectedDomain) renderUnitList(selectedDomain);
      break;
    case 'processing':
      document.getElementById('waiting-overlay').classList.add('active');
      break;
    case 'turn_result':
      document.getElementById('waiting-overlay').classList.remove('active');
      playTurnResult(msg.turn_data);
      break;
    case 'game_over':
      document.getElementById('waiting-overlay').classList.remove('active');
      showGameOver(msg.winner, msg.final_vp, msg.cost_summary);
      break;
    case 'error':
      alert('Server error: ' + msg.message);
      document.getElementById('waiting-overlay').classList.remove('active');
      enableOrdersPanel();
      break;
  }
}

// ── Faction Selection ──
function selectFaction(f){
  document.getElementById('faction-overlay').style.display = 'none';
  // Show force briefing
  document.getElementById('fb-title').textContent = 'COMMANDING: ' + f.toUpperCase();
  document.getElementById('force-briefing').classList.add('active');
  sendMsg('start_game', {faction: f});
}

function showForceBriefing() {
  // Count our forces from roster
  var cats = {};
  unitRoster.forEach(function(u){
    if(!cats[u.category]) cats[u.category] = 0;
    cats[u.category]++;
  });
  var statsEl = document.getElementById('fb-stats');
  statsEl.innerHTML = '';
  var catLabels = {aircraft:'Air Sqn',ground:'Ground Fmn',missile:'Missile Bat',artillery:'Artillery',
    helicopter:'Helicopters',drone:'Drones',air_defense:'Air Defense',special_forces:'Spec Ops'};
  Object.keys(cats).forEach(function(k){
    var div = document.createElement('div');div.className = 'fb-stat';
    var color = myFaction==='india'?'#2196F3':'#4CAF50';
    div.innerHTML = '<div class="fbs-value" style="color:'+color+'">'+cats[k]+'</div><div class="fbs-label">'+(catLabels[k]||k)+'</div>';
    statsEl.appendChild(div);
  });
  document.getElementById('fb-loading').textContent = 'LOADING ORDERS PANEL...';
  setTimeout(function(){
    document.getElementById('force-briefing').classList.remove('active');
  }, 2500);
}

// ── Map Init ──
function initMap(){
  if(map) return;
  map = L.map('map',{zoomControl:true}).setView([30.25,72.0],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap',maxZoom:12,minZoom:4}).addTo(map);
  unitLy=L.layerGroup().addTo(map);combatLy=L.layerGroup().addTo(map);animLy=L.layerGroup().addTo(map);
  samLy=L.layerGroup().addTo(map);riverLy=L.layerGroup().addTo(map);cityLy=L.layerGroup().addTo(map);
  airbaseLy=L.layerGroup().addTo(map);locLy=L.layerGroup().addTo(map);sectorLy=L.layerGroup();
  L.control.layers(null,{'Units':unitLy,'SAM Coverage':samLy,'Combat Events':combatLy,
    'Animations':animLy,'Rivers':riverLy,'Cities':cityLy,'Airbases':airbaseLy,
    'LOC / Border':locLy,'Sectors':sectorLy},{position:'topright',collapsed:true}).addTo(map);
  map.on('click', onMapClick);
  feedInit();
  buildDomainTabs();
}

// ── Static layers (from replay) ──
function drawStatic(){
  if(!staticData) return;
  var s = staticData;
  (s.rivers||[]).forEach(function(r){
    if(!r.path||r.path.length<2)return;
    L.polyline(r.path.map(function(p){return[p.lat,p.lon]}),{
      color:'#4488cc',weight:r.width>200?3:2,opacity:.6}).bindTooltip(r.name).addTo(riverLy);
  });
  (s.cities||[]).forEach(function(c){
    if(!c.lat)return;
    var cl=c.faction==='india'?'#5599dd':c.faction==='pakistan'?'#55aa77':'#888';
    var rd=c.type==='capital'?7:c.type==='major'?5:3;
    L.circleMarker([c.lat,c.lon],{radius:rd,color:cl,fillColor:cl,fillOpacity:.5,weight:1})
     .bindTooltip(c.name+(c.population>0?' ('+(c.population/1e6).toFixed(1)+'M)':'')).addTo(cityLy);
  });
  (s.airbases||[]).forEach(function(ab){
    if(!ab.lat)return;
    var cl=ab.faction==='india'?'#5599dd':'#55aa77';
    L.marker([ab.lat,ab.lon],{icon:L.divIcon({className:'airbase-icon',
      html:'<div style="color:'+cl+';font-size:16px;text-align:center">&#9992;</div>',
      iconSize:[20,20],iconAnchor:[10,10]})}).bindTooltip(ab.name).addTo(airbaseLy);
  });
  if(s.loc_path&&s.loc_path.length>=2){
    L.polyline(s.loc_path.map(function(p){return[p.lat,p.lon]}),{
      color:'#cc4444',weight:2,dashArray:'8,5',opacity:.7}).bindTooltip('Line of Control').addTo(locLy);
  }
  (s.sectors||[]).forEach(function(sec){
    if(!sec.north)return;
    L.rectangle([[sec.south,sec.west],[sec.north,sec.east]],{
      color:'#334455',weight:1,fillOpacity:.03,dashArray:'4,4'}).bindTooltip(sec.name+' ('+sec.terrain+')').addTo(sectorLy);
  });
  (s.sam_sites||[]).forEach(function(sam){
    if(!sam.lat)return;
    var cl=sam.faction==='india'?'#2196F3':'#4CAF50';
    L.circle([sam.lat,sam.lon],{radius:(sam.range_km||50)*1000,color:cl,weight:1,dashArray:'5,5',
      fillColor:cl,fillOpacity:.07}).bindTooltip(sam.name+' ('+sam.type+', '+sam.range_km+'km)').addTo(samLy);
  });
  (s.choke_points||[]).forEach(function(cp){
    if(!cp.lat)return;
    L.circleMarker([cp.lat,cp.lon],{radius:4,color:'#cc8844',fillColor:'#cc8844',fillOpacity:.6,weight:1})
     .bindTooltip(cp.name).addTo(locLy);
  });
}

// ── Show turn state (units + header) ──
function showTurnState(t){
  if(!t) return;
  document.getElementById('turn-display').textContent = 'Turn '+t.turn+'/'+maxTurns;
  document.getElementById('day-display').textContent = 'Day '+t.day+' '+cap(t.time);
  document.getElementById('weather-display').textContent = cap(t.weather);
  var iV=t.india_vp||0,pV=t.pakistan_vp||0,tot=Math.max(1,iV+pV);
  document.getElementById('india-vp').textContent=iV;
  document.getElementById('pakistan-vp').textContent=pV;
  document.getElementById('vp-india-bar').style.width=(iV/tot*100)+'%';
  document.getElementById('vp-pak-bar').style.width=(pV/tot*100)+'%';

  // Cost-of-war
  var iCD=t.india_cost_destroyed||0,pCD=t.pakistan_cost_destroyed||0;
  var iCK=t.india_cost_killed||0,pCK=t.pakistan_cost_killed||0;
  document.getElementById('india-cost').textContent=Math.round(iCD);
  document.getElementById('pakistan-cost').textContent=Math.round(pCD);
  var exEl=document.getElementById('exchange-display');
  if(iCD>0||pCD>0){
    var iR=iCK/Math.max(0.1,iCD+(t.india_munitions_usd||0));
    var pR=pCK/Math.max(0.1,pCD+(t.pakistan_munitions_usd||0));
    exEl.textContent='XR: IND '+iR.toFixed(1)+'x | PAK '+pR.toFixed(1)+'x';
  }

  drawUnits(t);
  drawCombatMarkers(t);
}

function drawUnits(t){
  unitLy.clearLayers();
  (t.units||[]).forEach(function(u){
    if(u.lat==null) return;
    var cl=u.faction==='india'?'#2196F3':'#4CAF50';
    var sz=catSize[u.category]||6;
    var op=u.status==='destroyed'?.2:u.status==='damaged'?.5:.85;
    L.marker([u.lat,u.lon],{icon:L.divIcon({className:'unit-icon',
      html:'<div style="width:'+sz+'px;height:'+sz+'px;background:'+cl+';border-radius:50%;opacity:'+op+';border:1px solid rgba(255,255,255,.3)"></div>',
      iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]})})
     .bindTooltip('<b>'+esc(u.name)+'</b><br>Type: '+esc(u.type)+'<br>'+u.category+' | '+u.status+'<br>Strength: '+u.strength+'%')
     .addTo(unitLy);
  });
}

function drawCombatMarkers(t){
  combatLy.clearLayers();
  (t.combat_events||[]).forEach(function(e){
    if(e.lat==null) return;
    L.marker([e.lat,e.lon],{icon:L.divIcon({className:'combat-pulse',
      html:'<div class="combat-dot"></div>',iconSize:[18,18],iconAnchor:[9,9]})})
     .bindTooltip('<b>'+esc(e.phase)+'</b><br>'+esc(e.attacker)+' vs '+esc(e.defender)+'<br>Result: '+esc(e.result)+
       (e.notes&&e.notes.length?'<br><i>'+e.notes.map(esc).join('<br>')+'</i>':''))
     .addTo(combatLy);
  });
}

// ── Battle Feed ──
var feedEl;
function feedInit(){ feedEl = document.getElementById('feed-left'); }
function feedClear(){
  if(!feedEl) feedInit();
  feedEl.innerHTML='<div class="feed-col-label">BATTLE FEED</div>';
  feedAddCursor(feedEl);
}
function feedAddCursor(el){var c=document.createElement('span');c.className='feed-cursor';el.appendChild(c);el.scrollTop=el.scrollHeight;}
function feedRemoveCursor(el){var cur=el.querySelector('.feed-cursor');if(cur)cur.remove();}
function feedLine(text,colorClass,tag){
  if(!feedEl)feedInit();
  feedRemoveCursor(feedEl);
  var div=document.createElement('div');div.className='feed-line '+(colorClass||'fc-white');div.textContent=text;
  if(tag){var sp=document.createElement('span');sp.className='feed-tag';sp.textContent=tag;div.appendChild(sp);}
  feedEl.appendChild(div);feedAddCursor(feedEl);
}
function feedPhaseHeader(text,color){
  if(!feedEl)feedInit();
  feedRemoveCursor(feedEl);
  var div=document.createElement('div');div.className='feed-phase';div.style.color=color||'#ccddee';
  div.textContent='\u2501\u2501 '+text+' \u2501\u2501';feedEl.appendChild(div);feedAddCursor(feedEl);
  sfx.phaseChime();
}
function feedSeparator(){
  if(!feedEl)feedInit();
  var div=document.createElement('div');div.className='feed-sep';feedEl.appendChild(div);
}

function eventToFeedLines(ev){
  var pd=phaseFor(ev);
  var isVic=ev.result&&ev.result.indexOf('victory')>=0;
  var isDef=ev.result&&ev.result.indexOf('defeat')>=0;
  var fColor=ev.attacker_faction==='india'?'fc-cyan':'fc-green';
  var sfxMap={missile:'missile',air:'air',drone:'drone',arty:'arty',heli:'heli',ground:'arty',sf:'sf'};
  var sfxType=sfxMap[pd.type]||'default';
  var actionMap={missile:'MISSILE LAUNCH',air:'AIR SORTIE',drone:'DRONE STRIKE',arty:'FIRE MISSION',heli:'HELI OPS',ground:'GROUND ASSAULT',sf:'SF OPS'};
  var action=actionMap[pd.type]||'ENGAGE';
  var faction=ev.attacker_faction||'india';
  var facLabel=faction==='india'?'[INDIA]':'[PAK]';
  var lines=[];
  lines.push({text:'\u25b8 '+action+' \u2014 '+fmtUnit(ev.attacker)+' '+facLabel,color:fColor,sfx:sfxType});
  if(ev.defender) lines.push({text:'  \u21b3 Target: '+fmtUnit(ev.defender),color:'fc-white'});
  return {opening:lines, closing:eventResultLines(ev,isVic,isDef,faction)};
}

function eventResultLines(ev,isVic,isDef,faction){
  var lines=[];
  var sym=isVic?'\u2726':isDef?'\u2717':'\u2014';
  var rColor=isVic?'fc-green':isDef?'fc-red':'fc-amber';
  var resultText=(ev.result||'engaged').toUpperCase();
  var sfxResult=isVic?'success':isDef?'fail':'default';
  lines.push({text:'  '+sym+' '+resultText,color:rColor,sfx:sfxResult});
  if(ev.notes&&ev.notes.length){
    ev.notes.forEach(function(n){
      var nLower=n.toLowerCase();
      var nColor=rColor;
      if(/destroy|kill|lost|shot down|wipe|cratered|penetrat/.test(nLower))nColor='fc-red';
      else if(/success|intercept|secured|complete|confirm/.test(nLower))nColor='fc-green';
      else if(/track|detect|surveil|intel|map/.test(nLower))nColor='fc-amber';
      lines.push({text:'    '+n,color:nColor});
    });
  }
  return lines;
}

async function streamFeedLines(lines,ctx,delayMs){
  for(var i=0;i<lines.length;i++){
    if(ctx&&ctx.cancelled)return;
    feedLine(lines[i].text,lines[i].color,lines[i].tag);
    var s=lines[i].sfx;
    if(s==='missile')sfx.missileLaunch();else if(s==='air')sfx.jetFlyby();else if(s==='drone')sfx.droneBuzz();
    else if(s==='arty')sfx.artyBoom();else if(s==='heli')sfx.heliRotor();else if(s==='sf')sfx.sfSilenced();
    else if(s==='fail')sfx.explosion(false);else if(s==='success')sfx.interceptHit();else sfx.feedTick();
    var d=lines[i].delay||delayMs||60;
    if(i<lines.length-1) await sleep(d/animSpeed);
  }
}

// ── Orders Panel ──
function buildDomainTabs(){
  var el=document.getElementById('domain-tabs');
  el.innerHTML='';
  DOMAINS.forEach(function(d){
    var btn=document.createElement('button');btn.textContent=d.label;btn.dataset.key=d.key;
    btn.onclick=function(){selectDomain(d.key);};
    el.appendChild(btn);
  });
}

function selectDomain(key){
  selectedDomain=key;selectedUnit=null;
  document.querySelectorAll('.domain-tabs button').forEach(function(b){b.classList.toggle('active',b.dataset.key===key);});
  document.getElementById('mission-form').classList.remove('active');
  document.getElementById('unit-search').value='';
  document.getElementById('preset-bar').style.display=(key==='aircraft')?'flex':'none';
  renderUnitList(key);
}

function renderUnitList(domainKey){
  var dom=DOMAINS.find(function(d){return d.key===domainKey;});
  if(!dom) return;
  var el=document.getElementById('unit-list');
  el.innerHTML='';
  var cats=Array.isArray(dom.cat)?dom.cat:[dom.cat];
  var filtered=unitRoster.filter(function(u){return cats.indexOf(u.category)>=0;});
  if(filtered.length===0){el.innerHTML='<div style="padding:12px;color:#556;text-align:center">No units in this domain</div>';return;}
  filtered.forEach(function(u){
    var card=document.createElement('div');
    card.className='unit-card'+(u.status==='destroyed'||u.status==='retreating'?' disabled':'');
    if(selectedUnit&&selectedUnit.id===u.id) card.classList.add('selected');
    var strColor=u.strength>60?'#4CAF50':u.strength>30?'#ff8844':'#ff4444';
    var statusCls=u.status==='ready'||u.status==='active'?'ready':u.status==='damaged'?'damaged':u.status==='destroyed'?'destroyed':'retreating';
    card.innerHTML='<div class="uc-name">'+esc(u.name)+'</div>'
      +'<div class="uc-meta"><span class="uc-type">'+esc(u.type||u.category)+'</span>'
      +'<span class="uc-str"><span class="uc-str-fill" style="width:'+u.strength+'%;background:'+strColor+'"></span></span>'
      +u.strength+'%'
      +'<span class="uc-status '+statusCls+'">'+u.status+'</span></div>';
    card.onclick=function(){ selectUnit(u, domainKey); };
    el.appendChild(card);
  });
}

function selectUnit(u, domainKey){
  selectedUnit=u;
  document.querySelectorAll('.unit-card').forEach(function(c){c.classList.remove('selected');});
  event.currentTarget.classList.add('selected');
  showMissionForm(u, domainKey);
}

function showMissionForm(u, domainKey){
  var dom=DOMAINS.find(function(d){return d.key===domainKey;});
  if(!dom) return;
  var form=document.getElementById('mission-form');
  form.classList.add('active');
  document.getElementById('mf-unit-name').textContent=u.name;

  // Mission dropdown
  var mSel=document.getElementById('mf-mission');
  mSel.innerHTML='';
  if(dom.key==='missile'){
    MISSILE_TARGET_TYPES.forEach(function(tt){var o=document.createElement('option');o.value=tt;o.textContent=tt.replace(/_/g,' ');mSel.appendChild(o);});
  } else if(dom.missions){
    dom.missions.forEach(function(m){var o=document.createElement('option');o.value=m;o.textContent=m.replace(/_/g,' ');mSel.appendChild(o);});
  }

  // Target dropdown
  var tSel=document.getElementById('mf-target');
  tSel.innerHTML='';
  targets.forEach(function(t){
    var o=document.createElement('option');o.value=t.id;
    o.textContent=(t.name||t.id).substring(0,40)+(t.type!=='enemy_unit'?' ['+t.type+']':'');
    tSel.appendChild(o);
  });

  // Extra field (count)
  var extraRow=document.getElementById('mf-extra-row');
  if(dom.extraField){
    extraRow.style.display='flex';
    document.getElementById('mf-extra-label').textContent=dom.extraLabel||'Count';
    document.getElementById('mf-extra').value=2;
  } else {
    extraRow.style.display=dom.hasPosture?'flex':'none';
  }

  // Posture (ground only)
  var postureLabel=document.getElementById('mf-posture-label');
  var postureSel=document.getElementById('mf-posture');
  if(dom.hasPosture){
    extraRow.style.display='flex';
    postureLabel.style.display='block';postureSel.style.display='block';
    postureSel.innerHTML='';
    dom.postures.forEach(function(p){var o=document.createElement('option');o.value=p;o.textContent=p;postureSel.appendChild(o);});
  } else {
    postureLabel.style.display='none';postureSel.style.display='none';
  }
}

function addOrder(){
  if(!selectedUnit||!selectedDomain) return;
  var dom=DOMAINS.find(function(d){return d.key===selectedDomain;});
  if(!dom) return;
  var orderKey=ORDER_KEYS[dom.key];
  if(!pendingOrders[orderKey]) pendingOrders[orderKey]=[];
  var mission=document.getElementById('mf-mission').value;
  var targetId=document.getElementById('mf-target').value;
  var order={};
  order[dom.idField]=selectedUnit.id;

  if(dom.key==='missile'){
    order.target_id=targetId;order.target_type=mission;
    order.missiles=parseInt(document.getElementById('mf-extra').value)||2;
  } else if(dom.key==='ground'){
    order.action=mission;order.target_id=targetId;
    order.posture=document.getElementById('mf-posture').value||'defend';
  } else {
    order.mission_type=mission;order.target_id=targetId;
  }
  if(dom.extraField&&dom.key!=='missile'){
    order[dom.extraField]=parseInt(document.getElementById('mf-extra').value)||2;
  }
  pendingOrders[orderKey].push(order);
  renderQueuedOrders();
}

function renderQueuedOrders(){
  var el=document.getElementById('queued-orders');
  el.innerHTML='<div class="queued-label">QUEUED ORDERS</div>';
  var count=0;
  for(var key in pendingOrders){
    var arr=pendingOrders[key];
    for(var i=0;i<arr.length;i++){
      count++;
      var o=arr[i];
      var catLabel=key.replace(/_/g,' ').substring(0,6).toUpperCase();
      var uid=o.battery_id||o.squadron_id||o.unit_id||'';
      var mission=o.mission_type||o.target_type||o.action||'';
      var tid=o.target_id||'';
      var div=document.createElement('div');div.className='q-order';
      div.innerHTML='<span class="q-cat">'+catLabel+'</span>'
        +'<span class="q-desc">'+esc(fmtUnit(uid))+' \u2192 '+mission+' \u2192 '+esc(fmtUnit(tid))+'</span>'
        +'<span class="q-remove" data-key="'+key+'" data-idx="'+i+'">\u00d7</span>';
      div.querySelector('.q-remove').onclick=function(){
        var k=this.dataset.key,idx=parseInt(this.dataset.idx);
        pendingOrders[k].splice(idx,1);
        if(pendingOrders[k].length===0)delete pendingOrders[k];
        renderQueuedOrders();
      };
      el.appendChild(div);
    }
  }
  document.getElementById('op-count').textContent=count;
  updateExpenditure();
}

function filterUnitList(){
  var q=(document.getElementById('unit-search').value||'').toLowerCase();
  document.querySelectorAll('#unit-list .unit-card').forEach(function(card){
    var name=(card.querySelector('.uc-name')||{}).textContent||'';
    card.style.display=name.toLowerCase().indexOf(q)>=0?'':'none';
  });
}

function applyPreset(preset){
  if(!unitRoster||!targets) return;
  var aircraft=unitRoster.filter(function(u){return u.category==='aircraft'&&u.status!=='destroyed';});
  if(preset==='sead'){
    var samTargets=targets.filter(function(t){return t.type==='sam_site';});
    aircraft.slice(0,Math.min(4,aircraft.length)).forEach(function(u,i){
      var tgt=samTargets[i%Math.max(1,samTargets.length)];
      if(!tgt) return;
      if(!pendingOrders.air_missions) pendingOrders.air_missions=[];
      pendingOrders.air_missions.push({squadron_id:u.id,mission_type:'sead',target_id:tgt.id,aircraft:2});
    });
  } else if(preset==='deep_strike'){
    var abTargets=targets.filter(function(t){return t.type==='airbase';});
    aircraft.slice(0,Math.min(3,aircraft.length)).forEach(function(u,i){
      var tgt=abTargets[i%Math.max(1,abTargets.length)];
      if(!tgt) return;
      if(!pendingOrders.air_missions) pendingOrders.air_missions=[];
      pendingOrders.air_missions.push({squadron_id:u.id,mission_type:'strike',target_id:tgt.id,aircraft:4});
    });
  } else if(preset==='air_sup'){
    aircraft.slice(0,Math.min(4,aircraft.length)).forEach(function(u,i){
      var missionType=i<2?'cap':'sweep';
      var tgt=targets[0];
      if(!tgt) return;
      if(!pendingOrders.air_missions) pendingOrders.air_missions=[];
      pendingOrders.air_missions.push({squadron_id:u.id,mission_type:missionType,target_id:tgt.id,aircraft:2});
    });
  }
  renderQueuedOrders();
}

function updateExpenditure(){
  var count=0;
  for(var key in pendingOrders){var arr=pendingOrders[key];if(arr)count+=arr.length;}
  var el=document.getElementById('planned-expenditure');
  if(count>0){el.textContent='QUEUED: '+count+' ORDERS';el.classList.add('visible');}
  else{el.classList.remove('visible');}
}

function selectDomainOld(){}

function submitTurn(){
  disableOrdersPanel();
  sendMsg('submit_orders',{turn:currentTurn, orders:pendingOrders});
}

function enableOrdersPanel(){
  document.getElementById('submit-btn').disabled=false;
  document.getElementById('waiting-overlay').classList.remove('active');
}
function disableOrdersPanel(){
  document.getElementById('submit-btn').disabled=true;
}

// ── Map Click Targeting ──
function startMapPick(){
  mapPicking=!mapPicking;
  document.getElementById('btn-pick-map').classList.toggle('picking',mapPicking);
  if(mapPicking) document.getElementById('map').style.cursor='crosshair';
  else document.getElementById('map').style.cursor='';
}

function onMapClick(e){
  if(!mapPicking) return;
  var lat=Math.round(e.latlng.lat*10)/10, lon=Math.round(e.latlng.lng*10)/10;
  // Check if near a known target
  var bestDist=Infinity, bestTarget=null;
  targets.forEach(function(t){
    if(t.lat==null) return;
    var d=haversineKm(lat,lon,t.lat,t.lon);
    if(d<20&&d<bestDist){bestDist=d;bestTarget=t;}
  });
  var tSel=document.getElementById('mf-target');
  if(bestTarget){
    tSel.value=bestTarget.id;
  } else {
    var areaId='area_'+lat+'_'+lon;
    var o=document.createElement('option');o.value=areaId;o.textContent='Area '+lat+', '+lon;
    tSel.appendChild(o);tSel.value=areaId;
  }
  mapPicking=false;
  document.getElementById('btn-pick-map').classList.remove('picking');
  document.getElementById('map').style.cursor='';
}

// ── Turn Result Playback ──
async function playTurnResult(turnData){
  cancelAnim();
  var ctx={cancelled:false};
  currentAnim=ctx;

  // Update header
  showTurnState(turnData);

  feedClear();
  feedLine('TURN '+turnData.turn+' \u2014 DAY '+turnData.day+' '+turnData.time.toUpperCase()+' \u2014 '+cap(turnData.weather),'fc-dim');
  feedSeparator();
  await sleep(300/animSpeed);
  if(ctx.cancelled) return;

  var events=turnData.combat_events||[];
  if(events.length===0){
    feedLine('No combat this turn \u2014 forces holding position','fc-dim');
    await sleep(400/animSpeed);
    return;
  }

  // Group by phase
  var groups=[];var used=new Array(events.length);
  for(var pi=0;pi<PHASE_DEFS.length;pi++){
    var pd=PHASE_DEFS[pi];var grp=[];
    for(var ei=0;ei<events.length;ei++){if(used[ei])continue;if(pd.match.test(events[ei].phase)){grp.push(events[ei]);used[ei]=true;}}
    if(grp.length>0) groups.push({def:pd,events:grp});
  }

  for(var gi=0;gi<groups.length;gi++){
    if(ctx.cancelled) return;
    var g=groups[gi];
    feedPhaseHeader(g.def.label,g.def.color);
    showPhaseLabel(g.def.label,g.def.color);
    await sleep(500/animSpeed);
    if(ctx.cancelled) return;

    var allFeedData=g.events.map(function(ev){return eventToFeedLines(ev);});
    for(var fi=0;fi<allFeedData.length;fi++){
      if(ctx.cancelled) return;
      await streamFeedLines(allFeedData[fi].opening,ctx,60);
      if(fi<allFeedData.length-1) await sleep(80/animSpeed);
    }
    await sleep(200/animSpeed);
    if(ctx.cancelled) return;

    var promises=g.events.map(function(ev){return animEvent(ev,ctx);});
    await Promise.all(promises);
    if(ctx.cancelled) return;

    g.events.forEach(function(ev){resultFloatText(ev);});

    for(var ri=0;ri<allFeedData.length;ri++){
      if(ctx.cancelled) return;
      await streamFeedLines(allFeedData[ri].closing,ctx,80);
    }
    feedSeparator();
    await sleep(500/animSpeed);
    animLy.clearLayers();
    hidePhaseLabel();
  }

  // Final state
  showTurnState(turnData);
}

// ── Game Over ──
var gameCostSummary = null;
function showGameOver(winner,vp,costSummary){
  gameCostSummary = costSummary;
  var el=document.getElementById('gameover-overlay');el.classList.add('active');
  var isWin=(winner===myFaction);
  var title=winner==='draw'?'DRAW':isWin?'VICTORY':'DEFEAT';
  var color=winner==='draw'?'#ffcc00':isWin?'#4CAF50':'#ff4444';
  document.getElementById('go-title').textContent=title;
  document.getElementById('go-title').style.color=color;
  document.getElementById('go-vp').textContent='India '+vp.india+' \u2014 Pakistan '+vp.pakistan;

  // Build cost report if available
  if(costSummary && (costSummary.india || costSummary.pakistan)) {
    var reportEl = document.getElementById('go-cost-report');
    if(reportEl) {
      reportEl.innerHTML = buildGameOverReport(costSummary, vp);
      reportEl.style.display = 'block';
    }
  }
}

function fmtKey(k){return k.replace(/_/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase();});}

function buildGameOverReport(cs, vp){
  var ind = cs.india || {}, pak = cs.pakistan || {};
  var iTotal = ind.total_cost_of_war_usd||0, pTotal = pak.total_cost_of_war_usd||0;
  var iXR = ind.exchange_ratio||0, pXR = pak.exchange_ratio||0;

  function catBars(data, maxVal, cls){
    if(!data||!Object.keys(data).length) return '';
    var html='';
    Object.keys(data).sort(function(a,b){return data[b]-data[a]}).forEach(function(k){
      var v=data[k]; var pct=Math.min(100,v/Math.max(1,maxVal)*100);
      html+='<div class="cost-bar-row"><span class="cost-bar-label">'+fmtKey(k)+'</span>';
      html+='<div class="cost-bar-track"><div class="cost-bar-fill '+cls+'" style="width:'+pct+'%"></div></div>';
      html+='<span class="cost-bar-value">$'+Math.round(v)+'M</span></div>';
    });
    return html;
  }

  var html = '<div class="cost-report" style="max-width:700px;margin-top:16px">';
  html += '<h2>Cost of War</h2><div class="subtitle">After-Action Report</div>';
  html += '<div class="cost-exchange"><span class="ratio india">'+iXR.toFixed(1)+'x</span>';
  html += '<span class="vs">INDIA XR | PAK XR</span><span class="ratio pakistan">'+pXR.toFixed(1)+'x</span></div>';
  html += '<div class="cost-grid">';

  ['india','pakistan'].forEach(function(f){
    var d = f==='india'?ind:pak;
    var total = d.total_cost_of_war_usd||0;
    var maxCat = Math.max.apply(null, Object.values(d.destroyed_by_category||{}).concat([1]));
    html += '<div class="cost-card '+f+'"><h3>'+f.charAt(0).toUpperCase()+f.slice(1)+'</h3>';
    html += '<div class="cost-big '+f+'">$'+Math.round(total)+'M</div>';
    html += '<div style="text-align:center;font-size:10px;color:#556;margin-bottom:10px">TOTAL COST</div>';
    html += '<div class="cost-row"><span class="label">Assets Lost</span><span class="value red">$'+Math.round(d.assets_lost_usd||0)+'M</span></div>';
    html += '<div class="cost-row"><span class="label">Enemy Destroyed</span><span class="value green">$'+Math.round(d.assets_killed_usd||0)+'M</span></div>';
    html += '<div class="cost-row"><span class="label">Munitions</span><span class="value amber">$'+Math.round(d.munitions_expended_usd||0)+'M</span></div>';
    html += '<div style="margin-top:8px;font-size:10px;color:#556;letter-spacing:1px;margin-bottom:4px">LOSSES BY DOMAIN</div>';
    html += catBars(d.destroyed_by_category, maxCat, 'red');
    html += '</div>';
  });

  html += '</div></div>';
  return html;
}

// ── Animation engine (from replay) ──
function sleep(ms){return new Promise(function(r){setTimeout(r,ms);});}
function lerp(a,b,t){return a+(b-a)*t;}
function easeInOut(t){return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;}
function cancelAnim(){if(currentAnim)currentAnim.cancelled=true;if(animLy)animLy.clearLayers();hidePhaseLabel();}
function showPhaseLabel(text,color){var el=document.getElementById('phase-overlay');el.textContent=text;el.style.color=color;el.style.borderColor=color;el.style.display='block';}
function hidePhaseLabel(){document.getElementById('phase-overlay').style.display='none';}

function screenShake(intensity){
  var el=document.getElementById('map');var start=performance.now();var dur=400/animSpeed;
  function step(ts){var elapsed=ts-start;if(elapsed>dur){el.style.transform='';return;}
    var decay=1-elapsed/dur;var x=(Math.random()-.5)*intensity*decay*2;var y=(Math.random()-.5)*intensity*decay*2;
    el.style.transform='translate('+x+'px,'+y+'px)';requestAnimationFrame(step);}
  requestAnimationFrame(step);
}

function showMapLabel(latlng,text,cssClass,duration){
  var m=L.marker(latlng,{icon:L.divIcon({className:'anim-icon',html:'<div class="'+cssClass+'">'+text+'</div>',
    iconSize:[500,28],iconAnchor:[250,-18]})}).addTo(animLy);
  setTimeout(function(){try{animLy.removeLayer(m);}catch(e){}},(duration||2500)/animSpeed);return m;
}

function showFloatText(latlng,text,colorClass,size){
  var cls='float-text';if(size==='large')cls+=' ft-large';else if(size==='small')cls+=' ft-small';if(colorClass)cls+=' '+colorClass;
  var m=L.marker(latlng,{icon:L.divIcon({className:'anim-icon',html:'<div class="'+cls+'">'+text+'</div>',
    iconSize:[400,24],iconAnchor:[200,-10]})}).addTo(animLy);
  setTimeout(function(){try{animLy.removeLayer(m);}catch(e){}},3500/animSpeed);return m;
}

function resultFloatText(ev){
  if(ev.lat==null)return;var pos=[ev.lat,ev.lon];
  var isVic=ev.result&&ev.result.indexOf('victory')>=0;var isDef=ev.result&&ev.result.indexOf('defeat')>=0;
  var note=evNote(ev);var colorCls=isVic?'ft-green':isDef?'ft-red':'ft-amber';
  var hasKill=/destroy|kill|shot down|wipe|crater/i.test(note);var sz=hasKill?'large':'small';
  var txt=note||(isVic?'TARGET HIT':isDef?'FAILED':'ENGAGED');
  if(txt.length>50)txt=txt.substring(0,47)+'...';
  showFloatText(pos,txt,colorCls,sz);
}

function mkExplosion(latlng,small){
  if(small)return L.marker(latlng,{icon:L.divIcon({className:'anim-icon',html:'<div class="boom-sm"></div>',iconSize:[36,36],iconAnchor:[18,18]})});
  return L.marker(latlng,{icon:L.divIcon({className:'anim-icon',
    html:'<div class="boom-wrap"><div class="boom-smoke"></div><div class="boom-ring"></div><div class="boom-core"></div></div>',
    iconSize:[80,80],iconAnchor:[40,40]})});
}
function mkFlash(latlng){return L.marker(latlng,{icon:L.divIcon({className:'anim-icon',
  html:'<div class="ground-flash-wrap"><div class="ground-flash-ring"></div><div class="ground-flash-core"></div></div>',
  iconSize:[60,60],iconAnchor:[30,30]})});}

function mkMissileSvg(color,size,type){
  var w=size||28,h=Math.round(w*0.4);
  if(type==='sam')return '<svg viewBox="0 0 28 8" width="'+w+'" height="'+h+'" style="overflow:visible"><defs><linearGradient id="sg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="'+color+'"/><stop offset="100%" stop-color="'+color+'" stop-opacity=".5"/></linearGradient></defs><path d="M27,4 L22,1.5 L3,2 L0,4 L3,6 L22,6.5 Z" fill="url(#sg)" stroke="rgba(255,255,255,.3)" stroke-width=".5"/><polygon points="5,0.5 7,2.5 5,2" fill="'+color+'" opacity=".7"/><polygon points="5,7.5 7,5.5 5,6" fill="'+color+'" opacity=".7"/></svg>';
  if(type==='ballistic')return '<svg viewBox="0 0 30 14" width="'+w+'" height="'+h+'" style="overflow:visible"><defs><linearGradient id="bg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="'+color+'"/><stop offset="100%" stop-color="'+color+'" stop-opacity=".4"/></linearGradient></defs><ellipse cx="15" cy="7" rx="14" ry="5" fill="url(#bg)" stroke="rgba(255,255,255,.25)" stroke-width=".5"/><path d="M29,7 L24,3 L24,11 Z" fill="'+color+'"/><polygon points="3,0 6,4 3,3" fill="'+color+'" opacity=".8"/><polygon points="3,14 6,10 3,11" fill="'+color+'" opacity=".8"/></svg>';
  return '<svg viewBox="0 0 32 12" width="'+w+'" height="'+h+'" style="overflow:visible"><defs><linearGradient id="cg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="'+color+'"/><stop offset="100%" stop-color="'+color+'" stop-opacity=".5"/></linearGradient></defs><path d="M31,6 L24,1.5 L4,2.5 L0,6 L4,9.5 L24,10.5 Z" fill="url(#cg)" stroke="rgba(255,255,255,.3)" stroke-width=".5"/><polygon points="14,0 18,3.5 14,2.5" fill="'+color+'" opacity=".6"/><polygon points="14,12 18,8.5 14,9.5" fill="'+color+'" opacity=".6"/></svg>';
}
function mkMissileIcon(from,to,color,size,missileType){
  var ang=-Math.atan2(to[0]-from[0],to[1]-from[1])*180/Math.PI;
  var svg=mkMissileSvg(color,size||28,missileType);var w=size||28;
  return '<div style="position:relative;transform:rotate('+ang+'deg);transform-origin:center">'+svg+'<div class="missile-exhaust"></div></div>';
}

function flyObject(from,to,opts,ctx){
  return new Promise(function(resolve){
    if(ctx.cancelled){resolve();return;}
    var dur=(opts.duration||1500)/animSpeed;var start=null;
    var trail=L.polyline([],{color:opts.trailColor||'#ff4444',weight:opts.trailWeight||2,opacity:opts.trailOpacity||.7,dashArray:opts.trailDash||null}).addTo(animLy);
    var head;
    if(opts.missile){
      var mhtml=mkMissileIcon(from,to,opts.missileColor||opts.trailColor||'#ff4444',opts.missileSize||28,opts.missileType||'cruise');
      head=L.marker(from,{icon:L.divIcon({className:'anim-icon',html:mhtml,iconSize:[opts.missileSize||28,(opts.missileSize||28)*0.5],iconAnchor:[(opts.missileSize||28)/2,(opts.missileSize||28)*0.25]})});
    } else if(opts.plane){
      var ang=-Math.atan2(to[0]-from[0],to[1]-from[1])*180/Math.PI;
      head=L.marker(from,{icon:L.divIcon({className:'anim-icon',html:'<div style="font-size:'+(opts.planeSize||14)+'px;color:'+(opts.trailColor||'#4499ff')+';transform:rotate('+ang+'deg);opacity:'+(opts.planeOpacity||1)+'">&#9992;</div>',iconSize:[20,20],iconAnchor:[10,10]})});
    } else {
      head=L.circleMarker(from,{radius:opts.headRadius||3,color:opts.headColor||'#ffaa00',fillColor:opts.headFill||'#ffcc00',fillOpacity:1,weight:1});
    }
    head.addTo(animLy);
    function step(ts){if(ctx.cancelled){resolve();return;}if(!start)start=ts;
      var raw=Math.min(1,(ts-start)/dur);var t=easeInOut(raw);
      var lat=lerp(from[0],to[0],t);var lon=lerp(from[1],to[1],t);
      if(head.setLatLng)head.setLatLng([lat,lon]);trail.addLatLng([lat,lon]);
      if(raw<1){requestAnimationFrame(step);}else{animLy.removeLayer(head);resolve();}}
    requestAnimationFrame(step);
  });
}

// ── SAM interception helpers ──
function haversineKm(lat1,lon1,lat2,lon2){
  var R=6371,rad=Math.PI/180;var dLat=(lat2-lat1)*rad,dLon=(lon2-lon1)*rad;
  var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*rad)*Math.cos(lat2*rad)*Math.sin(dLon/2)*Math.sin(dLon/2);
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function findDefendingSam(targetLat,targetLon,attackerFaction){
  var sams=(staticData&&staticData.sam_sites)||[];var best=null,bestDist=Infinity;
  for(var i=0;i<sams.length;i++){var s=sams[i];if(s.faction===attackerFaction)continue;
    var dist=haversineKm(s.lat,s.lon,targetLat,targetLon);if(dist<=s.range_km&&dist<bestDist){best=s;bestDist=dist;}}
  return best;
}
function mkInterceptBurst(latlng){return L.marker(latlng,{icon:L.divIcon({className:'anim-icon',html:'<div class="intercept-wrap"><div class="intercept-ring"></div><div class="intercept-core"></div></div>',iconSize:[60,60],iconAnchor:[30,30]})});}
function mkSamMissFlash(latlng){return L.marker(latlng,{icon:L.divIcon({className:'anim-icon',html:'<div class="sam-miss-flash"></div>',iconSize:[24,24],iconAnchor:[12,12]})});}
function mkDroneSwarm(latlng){var dots='';for(var i=0;i<8;i++){var x=10+Math.random()*40,y=10+Math.random()*40;dots+='<div class="drone-dot" style="left:'+x+'px;top:'+y+'px"></div>';}return L.marker(latlng,{icon:L.divIcon({className:'anim-icon',html:'<div class="drone-swarm-wrap">'+dots+'</div>',iconSize:[60,60],iconAnchor:[30,30]})});}
function mkDroneStrikeFlash(latlng){return L.marker(latlng,{icon:L.divIcon({className:'anim-icon',html:'<div class="drone-strike-flash"></div>',iconSize:[30,30],iconAnchor:[15,15]})});}
function mkHeliStrikeFlash(latlng){return L.marker(latlng,{icon:L.divIcon({className:'anim-icon',html:'<div class="heli-strafe-flash"></div>',iconSize:[24,24],iconAnchor:[12,12]})});}
function mkSFPing(latlng){return L.marker(latlng,{icon:L.divIcon({className:'anim-icon',html:'<div class="sf-ping-wrap"><div class="sf-ping-ring"></div><div class="sf-ping-core"></div></div>',iconSize:[50,50],iconAnchor:[25,25]})});}

function guessMissileType(ev){var a=(ev.attacker||'').toLowerCase();if(a.indexOf('nasr')>=0||a.indexOf('prithvi')>=0||a.indexOf('ghauri')>=0||a.indexOf('shaheen')>=0||a.indexOf('tbm')>=0)return 'ballistic';return 'cruise';}
function fmtUnit(id){return (id||'').replace(/_/g,' ').replace(/^(in|pk)\s/i,'').toUpperCase();}
function evNote(ev){return (ev.notes&&ev.notes.length)?ev.notes[0]:'';}

// ── Per-type animations (from replay) ──
function animMissile(ev,ctx){
  var from=[ev.from_lat,ev.from_lon],to=[ev.lat,ev.lon];
  var sam=(ev.interceptable!==false)?findDefendingSam(ev.lat,ev.lon,ev.attacker_faction):null;
  var mType=guessMissileType(ev);var mColor=ev.attacker_faction==='india'?'#ff6644':'#ff4444';
  var aName=fmtUnit(ev.attacker);var note=evNote(ev);
  showMapLabel(from,aName+' LAUNCHED','engage-label',2500);
  showMapLabel(to,'INCOMING \u2014 '+fmtUnit(ev.defender),'engage-label',3000);
  sfx.missileLaunch();
  if(!sam){
    return flyObject(from,to,{duration:1800,trailColor:mColor,trailWeight:2,missile:true,missileColor:mColor,missileSize:28,missileType:mType},ctx).then(function(){
      if(ctx.cancelled)return;mkExplosion(to,false).addTo(animLy);sfx.explosion(true);screenShake(8);
      showMapLabel(to,note||(aName+' HIT'),'kill-label',3000);return sleep(900/animSpeed);});
  }
  var isKill=ev.result.indexOf('defeat')>=0||ev.result.indexOf('stalemate')>=0;
  var interceptT=0.65;var interceptPt=[lerp(from[0],to[0],interceptT),lerp(from[1],to[1],interceptT)];
  var samPos=[sam.lat,sam.lon];var samColor=sam.faction==='india'?'#2196F3':'#4CAF50';
  L.circleMarker(samPos,{radius:8,color:samColor,weight:2,fillColor:samColor,fillOpacity:0.4}).addTo(animLy);
  showMapLabel(samPos,sam.type.toUpperCase()+' TRACKING','engage-label',2500);sfx.radarPing();
  if(isKill){
    return Promise.all([
      flyObject(from,interceptPt,{duration:1400,trailColor:mColor,trailWeight:2,missile:true,missileColor:mColor,missileSize:28,missileType:mType},ctx),
      sleep(500/animSpeed).then(function(){if(ctx.cancelled)return;showMapLabel(samPos,sam.type.toUpperCase()+' FIRES','engage-label',1800);sfx.missileLaunch();
        return flyObject(samPos,interceptPt,{duration:1000,trailColor:samColor,trailWeight:1.5,trailDash:'4,3',missile:true,missileColor:samColor,missileSize:20,missileType:'sam'},ctx);})
    ]).then(function(){if(ctx.cancelled)return;mkInterceptBurst(interceptPt).addTo(animLy);sfx.interceptHit();screenShake(5);
      showMapLabel(interceptPt,aName+' INTERCEPTED BY '+sam.type.toUpperCase(),'intercept-label',3000);return sleep(1000/animSpeed);});
  } else {
    return Promise.all([
      flyObject(from,to,{duration:1800,trailColor:mColor,trailWeight:2,missile:true,missileColor:mColor,missileSize:28,missileType:mType},ctx),
      sleep(400/animSpeed).then(function(){if(ctx.cancelled)return;showMapLabel(samPos,sam.type.toUpperCase()+' FIRES','engage-label',1800);sfx.missileLaunch();
        var missPt=[interceptPt[0]+(Math.random()-.5)*.08,interceptPt[1]+(Math.random()-.5)*.08];
        return flyObject(samPos,missPt,{duration:1000,trailColor:samColor,trailWeight:1.5,trailDash:'4,3',missile:true,missileColor:samColor,missileSize:20,missileType:'sam'},ctx).then(function(){
          if(ctx.cancelled)return;mkSamMissFlash(missPt).addTo(animLy);showMapLabel(missPt,'MISS','engage-label',1500);});})
    ]).then(function(){if(ctx.cancelled)return;mkExplosion(to,false).addTo(animLy);sfx.explosion(true);screenShake(8);
      showMapLabel(to,note||(aName+' \u2014 TARGET HIT'),'kill-label',3000);return sleep(900/animSpeed);});
  }
}

function animAir(ev,ctx){
  var from=[ev.from_lat,ev.from_lon],to=[ev.lat,ev.lon];
  var fColor=ev.attacker_faction==='india'?'#4499ff':'#44cc88';var aName=fmtUnit(ev.attacker);var dName=fmtUnit(ev.defender);var note=evNote(ev);
  var standoff=[lerp(from[0],to[0],0.4),lerp(from[1],to[1],0.4)];
  showMapLabel(from,aName+' SORTIE','engage-label',2500);showMapLabel(to,'TARGET: '+dName,'engage-label',3000);sfx.jetFlyby();
  return flyObject(from,standoff,{duration:1200,trailColor:fColor,trailWeight:1.5,trailDash:'6,4',trailOpacity:.5,plane:true},ctx).then(function(){
    if(ctx.cancelled)return;showMapLabel(standoff,aName+' \u2014 FOX THREE','engage-label',1800);sfx.missileLaunch();
    return Promise.all([
      flyObject(standoff,to,{duration:1000,trailColor:'#ffcc44',trailWeight:1.5,missile:true,missileColor:'#ffcc44',missileSize:18,missileType:'sam'},ctx).then(function(){
        if(ctx.cancelled)return;mkExplosion(to,true).addTo(animLy);sfx.explosion(false);screenShake(4);
        var hitText=ev.result.indexOf('victory')>=0?(note||'SPLASH ONE \u2014 '+dName):ev.result.indexOf('defeat')>=0?'MISSED \u2014 '+dName:'ENGAGED \u2014 '+dName;
        showMapLabel(to,hitText,ev.result.indexOf('victory')>=0?'kill-label':'engage-label',3000);return sleep(500/animSpeed);}),
      sleep(200/animSpeed).then(function(){if(ctx.cancelled)return;return flyObject(standoff,from,{duration:1400,trailColor:fColor,trailWeight:1,trailDash:'3,6',trailOpacity:.25,plane:true,planeSize:11,planeOpacity:.5},ctx);})
    ]);});
}

function animArty(ev,ctx){
  var from=[ev.from_lat,ev.from_lon],to=[ev.lat,ev.lon];var aName=fmtUnit(ev.attacker);var note=evNote(ev);
  var numRounds=12;var spreadLat=0.03,spreadLon=0.04;
  showMapLabel(from,aName+' \u2014 FIRE FOR EFFECT','engage-label',4000);mkFlash(from).addTo(animLy);sfx.artyBoom();
  var promises=[];
  for(var i=0;i<numRounds;i++){(function(idx){var delay=idx*(80+Math.random()*120);
    promises.push(sleep(delay/animSpeed).then(function(){if(ctx.cancelled)return;
      var jitter=[(Math.random()-.5)*spreadLat,(Math.random()-.5)*spreadLon];var target=[to[0]+jitter[0],to[1]+jitter[1]];
      return sleep((400+Math.random()*300)/animSpeed).then(function(){if(ctx.cancelled)return;
        mkExplosion(target,true).addTo(animLy);sfx.artyBoom();if(idx%4===0)screenShake(2+Math.random()*3);});}));})(i);}
  return Promise.all(promises).then(function(){if(ctx.cancelled)return;screenShake(5);
    showMapLabel(to,note||'FIRE MISSION COMPLETE','kill-label',2500);return sleep(600/animSpeed);});
}

function animGround(ev,ctx){
  if(ctx.cancelled)return Promise.resolve();var pos=[ev.lat,ev.lon];
  mkFlash(pos).addTo(animLy);sfx.explosion(false);screenShake(3);
  var hitText=ev.result.indexOf('victory')>=0?'POSITION TAKEN':ev.result.indexOf('defeat')>=0?'REPULSED':'CONTESTED';
  showMapLabel(pos,hitText,ev.result.indexOf('victory')>=0?'kill-label':'engage-label',2000);
  return sleep(1000/animSpeed);
}

function animDrone(ev,ctx){
  var hasFlight=ev.from_lat!=null&&ev.lat!=null&&(ev.from_lat!==ev.lat||ev.from_lon!==ev.lon);
  var to=[ev.lat,ev.lon];var aName=fmtUnit(ev.attacker);var note=evNote(ev);
  var isISR=(ev.phase||'').indexOf('isr')>=0||(note||'').toLowerCase().indexOf('isr')>=0;
  if(!hasFlight){
    mkDroneSwarm(to).addTo(animLy);sfx.droneBuzz();
    showMapLabel(to,aName+(isISR?' \u2014 ISR ORBIT':' \u2014 DRONE STRIKE'),'drone-label',3000);
    return sleep(800/animSpeed).then(function(){if(ctx.cancelled)return;
      if(!isISR){mkDroneStrikeFlash(to).addTo(animLy);sfx.explosion(false);screenShake(3);
        showMapLabel(to,ev.result.indexOf('victory')>=0?(note||'TARGET HIT'):'PARTIAL EFFECT',ev.result.indexOf('victory')>=0?'kill-label':'drone-label',2500);
      }else{showMapLabel(to,'INTEL GATHERED','drone-label',2000);}return sleep(700/animSpeed);});
  }
  var from=[ev.from_lat,ev.from_lon];var droneColor=ev.attacker_faction==='india'?'#8866ff':'#aa66ff';
  showMapLabel(from,aName+' DRONE STRIKE','drone-label',2500);sfx.droneBuzz();
  var promises=[];
  for(var i=0;i<3;i++){(function(idx){var jFrom=[from[0]+(Math.random()-.5)*.02,from[1]+(Math.random()-.5)*.02];
    var jTo=[to[0]+(Math.random()-.5)*.03,to[1]+(Math.random()-.5)*.03];
    promises.push(sleep((idx*150)/animSpeed).then(function(){if(ctx.cancelled)return;
      return flyObject(jFrom,jTo,{duration:1400+idx*100,trailColor:droneColor,trailWeight:1,trailDash:'2,4',trailOpacity:.4,headColor:droneColor,headFill:droneColor,headRadius:2},ctx);}));})(i);}
  return Promise.all(promises).then(function(){if(ctx.cancelled)return;
    mkDroneStrikeFlash(to).addTo(animLy);sfx.explosion(false);screenShake(3);
    showMapLabel(to,ev.result.indexOf('victory')>=0?(note||'TARGET HIT'):'PARTIAL DAMAGE',ev.result.indexOf('victory')>=0?'kill-label':'drone-label',3000);
    return sleep(700/animSpeed);});
}

function animHeli(ev,ctx){
  var hasFlight=ev.from_lat!=null&&ev.lat!=null&&(ev.from_lat!==ev.lat||ev.from_lon!==ev.lon);
  var to=[ev.lat,ev.lon];var aName=fmtUnit(ev.attacker);var dName=fmtUnit(ev.defender);var note=evNote(ev);
  var fColor=ev.attacker_faction==='india'?'#44ccaa':'#66ccaa';
  if(!hasFlight){sfx.heliRotor();mkFlash(to).addTo(animLy);showMapLabel(to,aName+' \u2014 ATTACK RUN','heli-label',2500);screenShake(3);return sleep(1000/animSpeed);}
  var from=[ev.from_lat,ev.from_lon];
  showMapLabel(from,aName+' ATTACK MISSION','heli-label',2500);sfx.heliRotor();
  return flyObject(from,to,{duration:1600,trailColor:fColor,trailWeight:1.5,trailDash:'4,3',trailOpacity:.5,plane:true,planeSize:14},ctx).then(function(){
    if(ctx.cancelled)return;showMapLabel(to,'ENGAGING \u2014 '+dName,'heli-label',2000);sfx.missileLaunch();
    var strafes=[];for(var i=0;i<3;i++){(function(idx){strafes.push(sleep((idx*200)/animSpeed).then(function(){if(ctx.cancelled)return;
      mkHeliStrikeFlash([to[0]+(Math.random()-.5)*.015,to[1]+(Math.random()-.5)*.015]).addTo(animLy);if(idx===0)sfx.explosion(false);}));})(i);}
    return Promise.all(strafes).then(function(){if(ctx.cancelled)return;screenShake(4);
      var hitText=ev.result.indexOf('victory')>=0?(note||'TARGET DESTROYED'):ev.result.indexOf('defeat')>=0?'SHOT DOWN':'ENGAGED';
      showMapLabel(to,hitText,ev.result.indexOf('victory')>=0?'kill-label':'heli-label',3000);
      return flyObject(to,from,{duration:1200,trailColor:fColor,trailWeight:1,trailDash:'3,6',trailOpacity:.2,plane:true,planeSize:11,planeOpacity:.4},ctx);});});
}

function animSF(ev,ctx){
  if(ctx.cancelled)return Promise.resolve();var to=[ev.lat,ev.lon];var aName=fmtUnit(ev.attacker);var note=evNote(ev);
  var isRecon=(note||'').toLowerCase().indexOf('recon')>=0;
  var hasFlight=ev.from_lat!=null&&ev.lat!=null&&(ev.from_lat!==ev.lat||ev.from_lon!==ev.lon);
  var p=hasFlight?flyObject([ev.from_lat,ev.from_lon],to,{duration:2000,trailColor:'#cc88ff',trailWeight:1,trailDash:'2,8',trailOpacity:.25,headColor:'#cc88ff',headFill:'#cc88ff',headRadius:2},ctx):Promise.resolve();
  return p.then(function(){if(ctx.cancelled)return;
    mkSFPing(to).addTo(animLy);sfx.sfSilenced();
    showMapLabel(to,aName+' \u2014 '+(isRecon?'RECON':'CONTACT'),'sf-label',2500);
    return sleep(800/animSpeed).then(function(){if(ctx.cancelled)return;
      var resultText=ev.result.indexOf('victory')>=0?(note||'MISSION SUCCESS'):ev.result.indexOf('defeat')>=0?'COMPROMISED':'PARTIAL';
      showMapLabel(to,resultText,ev.result.indexOf('victory')>=0?'kill-label':'sf-label',3000);return sleep(700/animSpeed);});});
}

function animEvent(ev,ctx){
  if(!ev.lat&&!ev.from_lat)return Promise.resolve();
  // Use from as fallback if to is missing
  if(ev.lat==null&&ev.from_lat!=null){ev.lat=ev.from_lat;ev.lon=ev.from_lon;}
  if(ev.from_lat==null&&ev.lat!=null){ev.from_lat=ev.lat;ev.from_lon=ev.lon;}
  var pd=phaseFor(ev);
  if(pd.type==='missile')return animMissile(ev,ctx);
  if(pd.type==='air')return animAir(ev,ctx);
  if(pd.type==='drone')return animDrone(ev,ctx);
  if(pd.type==='arty')return animArty(ev,ctx);
  if(pd.type==='heli')return animHeli(ev,ctx);
  if(pd.type==='sf')return animSF(ev,ctx);
  return animGround(ev,ctx);
}

// ── Sound effects (from replay) ──
var sfx = {
  ctx:null,
  init:function(){this.ctx=new(window.AudioContext||window.webkitAudioContext)();},
  ensure:function(){if(!this.ctx)this.init();if(this.ctx.state==='suspended')this.ctx.resume();},
  _noise:function(dur,shape){var c=this.ctx,len=Math.floor(c.sampleRate*dur);var buf=c.createBuffer(1,len,c.sampleRate),d=buf.getChannelData(0);
    for(var i=0;i<len;i++){var t=i/len;var env=shape==='punch'?Math.exp(-t*8):shape==='rumble'?Math.exp(-t*2)*(1+0.3*Math.sin(t*30)):shape==='crack'?(t<0.02?1:Math.exp(-(t-0.02)*12)):shape==='sustained'?Math.sin(Math.PI*t)*Math.exp(-t*1.5):Math.exp(-t*4);d[i]=(Math.random()*2-1)*env;}return buf;},
  _play:function(buf,filterType,freqStart,freqEnd,dur,gain,delay){var c=this.ctx,t0=c.currentTime+(delay||0);
    var s=c.createBufferSource();s.buffer=buf;var f=c.createBiquadFilter();f.type=filterType;
    f.frequency.setValueAtTime(freqStart,t0);if(freqEnd!==freqStart)f.frequency.exponentialRampToValueAtTime(Math.max(20,freqEnd),t0+dur);
    f.Q.value=filterType==='bandpass'?2:1;var g=c.createGain();g.gain.setValueAtTime(gain,t0);g.gain.exponentialRampToValueAtTime(0.001,t0+dur);
    s.connect(f);f.connect(g);g.connect(c.destination);s.start(t0);},
  missileLaunch:function(){if(!soundOn)return;this.ensure();
    this._play(this._noise(0.3,'punch'),'lowpass',120,40,0.3,0.25,0);this._play(this._noise(1.2,'sustained'),'bandpass',300,4000,1.2,0.15,0.05);
    this._play(this._noise(1.5,'rumble'),'lowpass',200,80,1.5,0.12,0.1);},
  explosion:function(big){if(!soundOn)return;this.ensure();var c=this.ctx,t0=c.currentTime;var dur=big?2.5:1.2;
    var o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.setValueAtTime(big?35:50,t0);o.frequency.exponentialRampToValueAtTime(20,t0+0.4);
    g.gain.setValueAtTime(big?0.5:0.3,t0);g.gain.exponentialRampToValueAtTime(0.001,t0+0.5);o.connect(g);g.connect(c.destination);o.start(t0);o.stop(t0+0.5);
    this._play(this._noise(0.15,'crack'),'bandpass',big?400:600,big?200:300,0.2,big?0.4:0.25,0);
    this._play(this._noise(dur,'rumble'),'lowpass',big?250:350,40,dur,big?0.2:0.1,0.05);},
  jetFlyby:function(){if(!soundOn)return;this.ensure();var c=this.ctx,t0=c.currentTime;
    var o=c.createOscillator(),g=c.createGain();o.type='sawtooth';o.frequency.setValueAtTime(180,t0);o.frequency.exponentialRampToValueAtTime(800,t0+0.4);o.frequency.exponentialRampToValueAtTime(120,t0+1.2);
    g.gain.setValueAtTime(0.03,t0);g.gain.linearRampToValueAtTime(0.1,t0+0.35);g.gain.exponentialRampToValueAtTime(0.001,t0+1.2);
    var f=c.createBiquadFilter();f.type='lowpass';f.frequency.value=3000;o.connect(f);f.connect(g);g.connect(c.destination);o.start(t0);o.stop(t0+1.3);
    this._play(this._noise(1.4,'sustained'),'bandpass',200,150,1.4,0.08,0);},
  radarPing:function(){if(!soundOn)return;this.ensure();var c=this.ctx,t0=c.currentTime;
    var o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.setValueAtTime(1200,t0);o.frequency.exponentialRampToValueAtTime(1800,t0+0.08);
    g.gain.setValueAtTime(0.1,t0);g.gain.exponentialRampToValueAtTime(0.001,t0+0.35);o.connect(g);g.connect(c.destination);o.start(t0);o.stop(t0+0.35);},
  interceptHit:function(){if(!soundOn)return;this.ensure();
    this._play(this._noise(0.08,'crack'),'highpass',2000,4000,0.1,0.35,0);this._play(this._noise(0.3,'punch'),'bandpass',800,400,0.3,0.2,0.02);},
  artyBoom:function(){if(!soundOn)return;this.ensure();var c=this.ctx,t0=c.currentTime;
    var o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.setValueAtTime(55,t0);o.frequency.exponentialRampToValueAtTime(25,t0+0.3);
    g.gain.setValueAtTime(0.35,t0);g.gain.exponentialRampToValueAtTime(0.001,t0+0.35);o.connect(g);g.connect(c.destination);o.start(t0);o.stop(t0+0.4);
    this._play(this._noise(0.1,'crack'),'bandpass',500,200,0.15,0.3,0);this._play(this._noise(1.5,'rumble'),'lowpass',200,50,1.5,0.1,0.05);},
  droneBuzz:function(){if(!soundOn)return;this.ensure();var c=this.ctx,t0=c.currentTime;
    var o=c.createOscillator(),g=c.createGain();o.type='sawtooth';o.frequency.setValueAtTime(280,t0);o.frequency.linearRampToValueAtTime(320,t0+0.3);o.frequency.linearRampToValueAtTime(260,t0+1.0);
    g.gain.setValueAtTime(0.05,t0);g.gain.linearRampToValueAtTime(0.07,t0+0.2);g.gain.exponentialRampToValueAtTime(0.001,t0+1.0);
    var f=c.createBiquadFilter();f.type='lowpass';f.frequency.value=1200;o.connect(f);f.connect(g);g.connect(c.destination);o.start(t0);o.stop(t0+1.1);},
  heliRotor:function(){if(!soundOn)return;this.ensure();var c=this.ctx,t0=c.currentTime;
    for(var i=0;i<8;i++){var t=t0+i*0.07;var o=c.createOscillator(),g=c.createGain();o.type='triangle';o.frequency.setValueAtTime(60+Math.random()*15,t);
      g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.05);o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+0.05);}
    this._play(this._noise(0.8,'sustained'),'lowpass',300,100,0.8,0.06,0);},
  sfSilenced:function(){if(!soundOn)return;this.ensure();
    for(var i=0;i<3;i++){this._play(this._noise(0.02,'crack'),'bandpass',2000,1000,0.04,0.15,i*0.18);this._play(this._noise(0.12,'punch'),'lowpass',400,150,0.15,0.08,i*0.18+0.01);}},
  feedTick:function(){if(!soundOn)return;this.ensure();var c=this.ctx,t0=c.currentTime;
    var o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=1000;
    g.gain.setValueAtTime(0.015,t0);g.gain.exponentialRampToValueAtTime(0.001,t0+0.03);o.connect(g);g.connect(c.destination);o.start(t0);o.stop(t0+0.03);},
  phaseChime:function(){if(!soundOn)return;this.ensure();var c=this.ctx,t0=c.currentTime;
    var o1=c.createOscillator(),g1=c.createGain();o1.type='sine';o1.frequency.value=800;
    g1.gain.setValueAtTime(0.06,t0);g1.gain.exponentialRampToValueAtTime(0.001,t0+0.3);o1.connect(g1);g1.connect(c.destination);o1.start(t0);o1.stop(t0+0.3);
    var o2=c.createOscillator(),g2=c.createGain();o2.type='sine';o2.frequency.value=1200;
    g2.gain.setValueAtTime(0.06,t0+0.15);g2.gain.exponentialRampToValueAtTime(0.001,t0+0.45);o2.connect(g2);g2.connect(c.destination);o2.start(t0+0.15);o2.stop(t0+0.45);}
};

function toggleSound(){soundOn=!soundOn;document.getElementById('sound-btn').innerHTML=soundOn?'&#128264;':'&#128263;';}
function toggleCRT(){document.getElementById('crt-overlay').classList.toggle('active');document.getElementById('crt-btn').classList.toggle('active');}

// ── Helpers ──
function cap(s){return s?s.charAt(0).toUpperCase()+s.slice(1):'';}
function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

// ── Init ──
document.addEventListener('DOMContentLoaded', function(){
  connectWS();
});
</script>
</body>
</html>
